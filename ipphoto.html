<!DOCTYPE html>
<html lang="vi" class="h-full antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STUDIO PHẠM KHANG - ID & VISA & VIDEO PRO</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        body: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.05)',
                            200: 'rgba(255, 255, 255, 0.1)',
                            300: 'rgba(255, 255, 255, 0.15)',
                            border: 'rgba(255, 255, 255, 0.1)',
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'blob': 'blob 7s infinite',
                        'scan': 'scan 2s linear infinite',
                        'toast-in': 'toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)', 
                        'toast-out': 'toastOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin': 'spin 0.8s linear infinite',
                        'modal-in': 'modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in-up': 'fadeInUp 0.3s ease-out forwards',
                        'fadeIn': 'fadeIn 0.5s ease-out forwards',
                        'radar': 'radarSpin 2s linear infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        scan: {
                            '0%': { top: '0%', opacity: '0' },
                            '10%': { opacity: '1' },
                            '90%': { opacity: '1' },
                            '100%': { top: '100%', opacity: '0' },
                        },
                        toastIn: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        toastOut: {
                            '0%': { transform: 'translateY(0)', opacity: '1' },
                            '100%': { transform: 'translateY(-20px)', opacity: '0' },
                        },
                        modalIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95) translateY(10px)' },
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        radarSpin: {
                            '0%': { transform: 'translate(-50%, -50%) rotate(0deg)' },
                            '100%': { transform: 'translate(-50%, -50%) rotate(360deg)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* V19.64 THEME - FIX: SEPARATE ACCESSORY LOGIC & RESET BUTTON */
        :root { --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        body { 
            background-color: #050505; 
            background-image: linear-gradient(to bottom, #050505, #111827);
            color: #e2e8f0;
        }
        
        .bg-blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.3; z-index: 0; animation: blob 10s infinite; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #6366f1; }
        .blob-2 { bottom: -10%; right: -10%; width: 500px; height: 500px; background: #ec4899; animation-delay: 2s; }
        .blob-3 { top: 40%; left: 40%; width: 400px; height: 400px; background: #06b6d4; animation-delay: 4s; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 20px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        .glass-panel { background: rgba(10, 10, 15, 0.85); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-right: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        
        @media (max-width: 1024px) {
            .mobile-sidebar-bg { background: rgba(5, 5, 8, 0.98) !important; backdrop-filter: blur(30px) !important; box-shadow: 5px 0 30px rgba(0,0,0,0.6); border-right: 1px solid rgba(255,255,255,0.1); }
        }

        .pro-input { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); color: #f1f5f9; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 12px; border-radius: 12px; padding-left: 12px; }
        .pro-input:focus { background: rgba(255, 255, 255, 0.08); border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); outline: none; }
        
        /* MODERN GRID BUTTONS */
        .category-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 12px 4px; border-radius: 16px; gap: 8px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s ease; cursor: pointer; position: relative; overflow: hidden;
        }
        .category-btn:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .category-btn:active { transform: translateY(0); }
        .category-btn span { font-size: 10px; font-weight: 700; text-transform: uppercase; text-align: center; line-height: 1.2; color: #e2e8f0; }
        .category-btn svg { width: 24px; height: 24px; color: #818cf8; transition: color 0.2s; }
        .category-btn:hover svg { color: #c084fc; }

        /* MODAL STYLES */
        .outfit-item {
            padding: 14px 16px; margin-bottom: 8px; border-radius: 12px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: space-between;
        }
        .outfit-item:hover { background: rgba(99, 102, 241, 0.15); border-color: rgba(99, 102, 241, 0.3); }
        .outfit-item.selected {
            background: rgba(99, 102, 241, 0.2); border-color: #818cf8;
        }
        .outfit-item .name { font-size: 12px; font-weight: 500; color: #cbd5e1; }
        .outfit-item.selected .name { color: white; font-weight: 700; }
        .outfit-item .check { width: 18px; height: 18px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .outfit-item.selected .check { background: #818cf8; border-color: #818cf8; box-shadow: 0 0 10px rgba(129, 140, 248, 0.5); }
        .outfit-item.selected .check::after { content: ''; width: 6px; height: 6px; background: white; border-radius: 50%; }

        .section-label { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; margin-bottom: 8px; display: block; }
        
        .btn-primary-modern { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #db2777 100%); background-size: 200% 200%; animation: gradientBG 5s ease infinite; border: none; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3); transition: all 0.3s ease; border-radius: 16px; }
        .btn-primary-modern:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4); }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .scan-beam { position: absolute; width: 100%; height: 3px; background: #22d3ee; box-shadow: 0 0 20px #22d3ee, 0 0 40px #67e8f9; z-index: 50; display: none; pointer-events: none; }
        .scan-beam.active { display: block; animation: scan 2s cubic-bezier(0.4, 0, 0.2, 1) infinite; }
        
        .modern-loader { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: #a855f7; border-right-color: #ec4899; animation: spin 0.8s linear infinite; }

        /* VISA MODULE STYLES */
        .mode-active { background: rgba(255,255,255,0.1); color: white; border-left: 2px solid #6366f1; }
        .mode-inactive { color: #94a3b8; border-left: 2px solid transparent; }
        .mode-inactive:hover { background: rgba(255,255,255,0.05); color: #e2e8f0; }
        
        .visa-country-btn { position: relative; overflow: hidden; transition: all 0.2s; }
        .visa-country-btn.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.15); box-shadow: 0 0 10px rgba(59,130,246,0.3); }
        .visa-overlay-guide { transition: all 0.3s ease; pointer-events: none; }

        /* VIDEO COMPARE STYLES */
        .vid-active-btn { background: #2563eb; border-color: #3b82f6; color: white; font-weight: bold; }
        .vid-inactive-btn { background: #0f172a; border-color: #475569; color: #94a3b8; }
        .vid-inactive-btn:hover { background: #1e293b; color: #e2e8f0; }
        .video-thumb-container { background: #0f172a; border: 2px dashed #475569; overflow: hidden; position: relative; transition: all 0.3s; }
        .video-thumb-container:hover { border-color: #3b82f6; }

        /* NEW VISA GUIDES */
        .visa-guide-high-viz {
            box-shadow: 0 0 15px currentColor;
            opacity: 1 !important;
        }
        .visa-radar {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0%, rgba(34, 211, 238, 0.2) 50%, rgba(34, 211, 238, 0.8) 100%);
            mask-image: radial-gradient(circle, transparent 60%, black 70%);
            -webkit-mask-image: radial-gradient(circle, transparent 60%, black 70%);
            animation: radarSpin 2s linear infinite;
            pointer-events: none;
            z-index: 5;
            display: none;
        }
        .visa-guide-label-box {
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="text-slate-200 font-sans h-screen flex overflow-hidden select-none relative">
    <div class="bg-blob blob-1"></div><div class="bg-blob blob-2"></div><div class="bg-blob blob-3"></div>
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <div class="flex w-full h-full relative z-10 backdrop-blur-[1px]" id="fullscreen-target">
        <!-- SIDEBAR -->
        <aside id="sidebar" class="w-[380px] flex-shrink-0 glass-panel mobile-sidebar-bg flex flex-col transition-transform duration-500 ease-[cubic-bezier(0.33,1,0.68,1)] absolute z-50 h-full lg:relative lg:translate-x-0 -translate-x-full z-50">
            <div class="h-20 px-6 flex items-center justify-between border-b border-white/5">
                <div class="flex flex-col">
                    <h1 class="text-lg font-extrabold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 font-sans drop-shadow-sm">PHẠM KHANG</h1>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-400 font-medium tracking-wide bg-white/5 px-2 py-0.5 rounded-full">V19.64</span>
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 shadow-[0_0_8px_#34d399] animate-pulse"></span>
                    </div>
                </div>
                <button id="close-sidebar-mobile" class="lg:hidden text-slate-400 hover:text-white bg-white/5 p-2 rounded-full transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>

            <!-- MODE SWITCHER -->
            <div class="px-6 pt-4 pb-2 border-b border-white/5">
                 <div class="flex flex-col gap-1">
                     <button onclick="switchMode('id')" id="btn-mode-id" class="mode-active w-full text-left px-4 py-3 rounded-lg text-xs font-bold uppercase tracking-wider transition-all flex items-center gap-3">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path></svg>
                         ID Photo Core
                     </button>
                     <button onclick="switchMode('visa')" id="btn-mode-visa" class="mode-inactive w-full text-left px-4 py-3 rounded-lg text-xs font-bold uppercase tracking-wider transition-all flex items-center gap-3">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                         Visa Photo Pro
                     </button>
                     <button onclick="switchMode('video')" id="btn-mode-video" class="mode-inactive w-full text-left px-4 py-3 rounded-lg text-xs font-bold uppercase tracking-wider transition-all flex items-center gap-3">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                         Video So Sánh Pro
                     </button>
                 </div>
            </div>

            <!-- ID PHOTO SIDEBAR CONTENT -->
            <div id="sidebar-content-id" class="flex-1 flex flex-col overflow-hidden h-full">
                <div class="flex-1 overflow-y-auto p-6 scroll-smooth custom-scrollbar">
                    <div class="relative group mb-6">
                        <input type="file" id="image-upload" accept="image/*" class="hidden">
                        <label id="drop-zone" for="image-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-indigo-500/20 rounded-2xl cursor-pointer bg-white/[0.02] hover:bg-white/[0.05] hover:border-indigo-500/50 transition-all duration-300 group-hover:scale-[1.01] group-hover:shadow-lg">
                            <div id="upload-placeholder" class="flex flex-col items-center transition-all duration-300">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500/20 to-purple-500/20 flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300 border border-white/10 shadow-inner">
                                    <svg class="w-5 h-5 text-indigo-300 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                                </div>
                                <p class="text-[10px] font-bold text-slate-300 uppercase tracking-wide group-hover:text-white transition-colors">Tải ảnh gốc lên</p>
                            </div>
                        </label>
                    </div>

                    <!-- Module: Lựa Chọn Trang Phục (Giao diện Lưới & Modal) -->
                    <div class="space-y-4">
                        
                        <!-- 1. Danh Mục Trang Phục -->
                        <div>
                            <span class="section-label flex items-center gap-2"><div class="w-1 h-3 bg-indigo-500 rounded-full"></div>Bước 1: Chọn Chế Độ / Trang Phục</span>
                            <div class="grid grid-cols-2 gap-3 mb-3" id="category-grid">
                                <!-- JS Generated Grid -->
                            </div>
                        </div>

                        <!-- 2. Hiển thị lựa chọn hiện tại -->
                        <div id="current-selection-display" class="hidden animate-fade-in-up">
                            <span class="section-label flex items-center gap-2"><div class="w-1 h-3 bg-purple-500 rounded-full"></div>Đã Chọn:</span>
                            <div class="p-4 bg-gradient-to-r from-indigo-500/20 to-purple-500/20 rounded-xl border border-indigo-500/30 flex items-center justify-between">
                                <span id="selected-outfit-name" class="text-xs font-bold text-white">Chưa chọn</span>
                                <button id="reopen-modal-btn" class="text-[10px] bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg transition-colors text-indigo-300 font-bold uppercase">Đổi</button>
                            </div>
                            <input type="hidden" id="selected-outfit-value" value="">
                        </div>

                        <!-- 3. Phụ Kiện Đi Kèm (Tùy Chọn) -->
                        <div>
                            <span class="section-label flex items-center gap-2"><div class="w-1 h-3 bg-pink-500 rounded-full"></div>Bước 2: Phụ Kiện Bổ Sung (Tùy chọn)</span>
                            <select id="secondary-accessory-select" class="pro-input w-full p-3 cursor-pointer">
                                <option value="">-- Không thêm phụ kiện --</option>
                                <optgroup label="Bộ Trang Sức Vàng (Đã Sửa: Hạ Thấp Tối Đa)">
                                    <option value=", đeo bộ vòng kiềng vàng cứng bản nhỏ (wearing THIN solid gold neck ring), nằm thấp đè nặng lên xương ức (resting HEAVY on sternum), không được hở cổ (no gap with skin), nằm sát chân cổ (sitting at very base of neck), có bóng đổ lên da (shadow on skin), bông tai vàng">Bộ Kiềng Vàng (Ôm Sát Chân Cổ)</option>
                                    <option value=", đeo dây chuyền vàng sợi nhỏ tiêu chuẩn (wearing STANDARD THIN GOLD CHAIN), dây kim loại nặng rủ xuống xương ức (heavy metal chain hanging low to sternum), nằm ệp xuống ngực (laying FLAT against chest), ôm sát theo da thịt (contouring to skin), có bóng đổ dưới dây (shadow under chain), bông tai vàng">Bộ Dây Chuyền Vàng + Đá</option>
                                    <option value=", đeo dây chuyền vàng trơn sợi nhỏ (wearing STANDARD THIN GOLD CHAIN), sợi dây mảnh mềm mại (soft limp chain), nằm rạp trên xương quai xanh (resting flush on collarbone), không có khe hở với da (no gap with skin), trọng lực kéo xuống (gravity pull), bông tai nụ nhỏ">Dây Chuyền Vàng (Sợi Nhỏ Trơn)</option>
                                    
                                    <!-- MỚI: BỔ SUNG CÁC LOẠI DÂY VÀNG NHỎ -->
                                    <option value=", đeo dây chuyền vàng sợi mì xoắn nhỏ (wearing delicate twisted gold rope chain), sợi dây xoắn nhuyễn (fine twisted links), rủ mềm mại trên ngực (soft drape on chest), lấp lánh nhẹ (subtle sparkle), bông tai vàng nhỏ">Dây Chuyền Vàng (Dây Mì Xoắn)</option>
                                    <option value=", đeo dây chuyền vàng hạt bi nhỏ (wearing gold bead chain necklace), chuỗi hạt bi vàng nhỏ li ti (tiny gold beads), sợi mảnh tinh tế (dainty), nằm thấp tự nhiên, bông tai nụ vàng">Dây Chuyền Vàng (Dây Bi Nhỏ)</option>
                                    <option value=", đeo dây chuyền vàng mắt xích vuông nhỏ (wearing thin box chain necklace), mắt xích vuông mảnh (fine box links), dáng dây cứng cáp nhưng mảnh (sturdy but thin), nằm êm trên da, bông tai vàng">Dây Chuyền Vàng (Xích Vuông Mảnh)</option>
                                    <option value=", đeo dây chuyền vàng mặt cỏ 4 lá nhỏ (wearing thin gold chain with small four-leaf clover pendant), mặt dây nhỏ xinh (petite pendant), sợi dây siêu mảnh (whisper thin), phong cách trẻ trung, bông tai nhỏ">Dây Chuyền Vàng (Cỏ 4 Lá)</option>
                                    <option value=", đeo dây chuyền vàng mặt tim nhỏ (wearing thin gold chain with small heart pendant), mặt tim vàng bé xíu (tiny heart), dây mảnh như chỉ (thread-like chain), nằm hõm cổ (resting in hollow of throat), bông tai tim nhỏ">Dây Chuyền Vàng (Mặt Tim Nhỏ)</option>
                                </optgroup>
                                <optgroup label="Bộ Sưu Tập Ngọc Trai (Đã Hạ Thấp & Bám Da)">
                                    <option value=", đeo chuỗi ngọc trai hạt siêu nhỏ (wearing dainty pearl necklace with TINY micro-pearls), hạt ngọc trai nặng rủ xuống (heavy beads hanging), nằm đè lên da (pressing on skin), bám sát vòng cổ (following neck curve), không bay (not flying), bông tai ngọc trai nhỏ">Ngọc Trai (1 Sợi - Hạt Nhỏ)</option>
                                    <option value=", đeo chuỗi ngọc trai dáng dài (wearing long pearl necklace), hạt ngọc trai nặng rủ sâu (heavy drape), nằm sát ngực (flat against chest), chuyển động theo dáng người, bông tai ngọc trai">Ngọc Trai (Dáng Dài)</option>
                                    <option value=", đeo chuỗi ngọc trai 2 sợi hạt nhỏ (wearing double strand pearl necklace with SMALL beads), 2 lớp ngọc trai nằm chồng lên nhau trên ngực (layers resting on chest), có trọng lượng (weighted drape), không bị phồng (not puffy), bông tai ngọc trai">Ngọc Trai (2 Sợi - Sang Trọng)</option>
                                    <option value=", đeo chuỗi ngọc trai 3 sợi hạt tấm (wearing triple strand pearl necklace with TINY SEED PEARLS), 3 lớp mảnh nằm êm trên da (lying flat on skin), rủ mềm mại (soft drape), không lơ lửng, phong cách hoàng gia, bông tai ngọc trai">Ngọc Trai (3 Sợi - Hoàng Gia)</option>
                                </optgroup>
                                <optgroup label="Đá Quý & Khác">
                                    <option value=", đeo dây chuyền ngọc cẩm thạch xanh dây mảnh (wearing thin green jade necklace), mặt ngọc nặng kéo dây xuống thấp (heavy pendant pulling chain LOW), dây nằm sát da ngực (chain touching chest skin), có bóng đổ, bông tai cẩm thạch">Bộ Cẩm Thạch (Ngọc Bích)</option>
                                    <option value=", đeo dây chuyền bạch kim mảnh sáng (wearing thin platinum chain), đính kim cương nhỏ (small diamond pendant), nằm thấp tự nhiên (natural low fit), bám sát cổ (hugging neck), tuyệt đối không bay, bông tai kim cương">Bộ Bạch Kim (Kim Cương)</option>
                                    <option value=", đeo chuỗi tràng hạt gỗ hạt nhỏ (wearing small wooden buddhist prayer beads necklace), hạt gỗ có sức nặng (weighted beads), rủ xuống ngực (hanging on chest), bám sát cổ áo">Chuỗi tràng hạt (Gỗ)</option>
                                </optgroup>
                                <optgroup label="Tôn Giáo / Khác">
                                    <option value=", đeo dây chuyền vàng sợi nhỏ mặt Phật (wearing STANDARD THIN GOLD CHAIN with small Buddha pendant), mặt Phật nặng nằm trên ngực (heavy pendant on chest), dây bám sát da, không bị lật (no flip), có bóng đổ">Dây chuyền Mặt Phật</option>
                                    <option value=", đeo chuỗi hạt Mân Côi Công Giáo hạt nhỏ (wearing thin catholic rosary beads necklace with small cross), rủ thấp xuống ngực, thánh giá nằm trên áo">Chuỗi Mân Côi (Công Giáo)</option>
                                </optgroup>
                                <optgroup label="Mắt Kính">
                                    <option value=", đeo kính lão gọng vàng mảnh tri thức (wearing thin gold rim reading glasses)">Kính lão (Gọng vàng)</option>
                                    <option value=", đeo kính lão gọng nhựa đen mỏng (wearing thin black frame reading glasses)">Kính lão (Gọng đen)</option>
                                    <option value=", đeo kính cận gọng kim loại siêu mỏng (wearing ultra thin metal frame glasses)">Kính cận (Kim loại)</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- 4. Hiển thị lựa chọn PHỤ KIỆN hiện tại (MỚI) -->
                        <div id="accessory-selection-display" class="hidden animate-fade-in-up">
                            <span class="section-label flex items-center gap-2"><div class="w-1 h-3 bg-pink-400 rounded-full"></div>Đã Chọn Phụ Kiện:</span>
                            <div class="p-3 bg-gradient-to-r from-pink-500/10 to-purple-500/10 rounded-xl border border-pink-500/20 flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-pink-500/20 flex items-center justify-center text-pink-400">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                                </div>
                                <span id="selected-accessory-name" class="text-xs font-bold text-white truncate"></span>
                            </div>
                        </div>

                        <!-- 5. Phông Nền -->
                        <div>
                            <span class="section-label flex items-center gap-2"><div class="w-1 h-3 bg-blue-500 rounded-full"></div>Bước 3: Phông Nền</span>
                            <div class="grid grid-cols-2 gap-3">
                                <button data-bg="solid deep blue background, professional ID photo blue backdrop, azure blue wall, studio lighting, no shadows" class="id-bg-btn py-2.5 px-3 rounded-xl border border-blue-500/20 text-[10px] bg-blue-500/10 hover:bg-blue-500 hover:text-white text-blue-200 font-semibold transition-all duration-300 shadow-sm flex items-center justify-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-blue-500 border border-white/20"></div>Nền Xanh
                                </button>
                                <button data-bg="solid pure white background, hex color #FFFFFF, clean bright white backdrop, high key lighting, no shadows, professional ID photo" class="id-bg-btn py-2.5 px-3 rounded-xl border border-white/20 text-[10px] bg-white/10 hover:bg-white hover:text-slate-900 text-white font-semibold transition-all duration-300 shadow-sm flex items-center justify-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-white border border-gray-300"></div>Nền Trắng
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="p-5 glass-panel border-t-0 space-y-3 z-20 rounded-t-3xl">
                    <button id="process-image" class="w-full py-4 btn-primary-modern text-white font-extrabold text-xs tracking-widest flex justify-center items-center gap-3 disabled:opacity-70 disabled:cursor-not-allowed group"><svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>TẠO ẢNH (ENTER)</button>
                    <button id="reset-button" class="w-full py-3 bg-white/5 hover:bg-white/10 text-slate-400 hover:text-slate-200 text-[10px] font-bold tracking-widest rounded-xl transition-all border border-white/5 hover:border-white/10">LÀM MỚI TẤT CẢ</button>
                </div>
            </div>

            <!-- VISA PHOTO SIDEBAR CONTENT (Hidden by default) -->
             <div id="sidebar-content-visa" class="hidden flex-1 flex flex-col overflow-hidden h-full">
                <div class="flex-1 overflow-y-auto p-6 scroll-smooth custom-scrollbar">
                     <!-- Instructions -->
                     <div class="mb-6 bg-blue-500/10 p-4 rounded-xl border border-blue-500/20">
                         <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2 text-xs uppercase tracking-wider">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                             Hướng Dẫn Visa Pro
                         </h3>
                         <ul class="text-[10px] text-blue-200 space-y-1.5 list-disc pl-4">
                             <li>Chọn Quốc Gia cần làm Visa.</li>
                             <li>Tải ảnh chân dung (nên dùng ảnh gốc).</li>
                             <li>Hệ thống tự động căn chỉnh (Auto Align).</li>
                             <li>Tinh chỉnh thu/phóng nếu cần.</li>
                             <li>Tải về và in ấn.</li>
                         </ul>
                     </div>

                     <!-- Country Selection -->
                     <div>
                        <span class="section-label flex items-center gap-2"><div class="w-1 h-3 bg-emerald-500 rounded-full"></div>Chọn Quốc Gia / Loại Visa</span>
                        <div class="grid grid-cols-2 gap-3 mb-6" id="visa-country-grid">
                            <!-- JS Generated Visa Countries -->
                        </div>
                     </div>
                     
                     <!-- Visa Actions -->
                     <div class="space-y-3">
                         <span class="section-label flex items-center gap-2"><div class="w-1 h-3 bg-purple-500 rounded-full"></div>Công Cụ</span>
                         <button id="visa-auto-align-btn" class="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold rounded-xl shadow-lg border border-white/10 flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                             AUTO ZOOM & CĂN CHỈNH
                         </button>
                         <div class="flex items-center gap-3 bg-white/5 p-3 rounded-xl border border-white/5">
                             <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                             <input type="range" id="visa-zoom-slider" min="0.1" max="3" step="0.01" value="1" class="w-full h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                         </div>
                     </div>
                </div>
                
                 <!-- Visa Footer -->
                <div class="p-5 glass-panel border-t-0 space-y-3 z-20 rounded-t-3xl">
                     <button id="visa-download-btn" class="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white font-extrabold text-xs tracking-widest flex justify-center items-center gap-3 shadow-lg border border-white/10 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                         TẢI ẢNH VỀ
                     </button>
                </div>
             </div>
        </aside>

        <!-- OUTFIT SELECTION MODAL (Keep Existing) -->
        <div id="outfit-modal" class="fixed inset-0 z-[100] hidden">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity" id="modal-backdrop"></div>
            <div class="absolute inset-0 flex items-center justify-center p-4">
                <div class="bg-[#0f172a] border border-white/10 w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh] animate-modal-in ring-1 ring-white/10">
                    <div class="px-6 py-5 border-b border-white/5 flex items-center justify-between bg-white/5">
                        <div class="flex items-center gap-3">
                            <div id="modal-icon" class="w-10 h-10 rounded-xl bg-indigo-500/20 flex items-center justify-center text-indigo-400"></div>
                            <div>
                                <h3 id="modal-title" class="text-white font-bold text-sm uppercase tracking-wider"></h3>
                                <p class="text-[10px] text-slate-400 font-medium">Chọn một kiểu dáng bên dưới</p>
                            </div>
                        </div>
                        <button id="close-modal-btn" class="p-2 bg-white/5 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    </div>
                    <div id="modal-list-content" class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-1"></div>
                </div>
            </div>
        </div>

        <!-- MAIN WORKSPACE WRAPPER -->
        <main class="flex-1 flex flex-col relative overflow-hidden bg-[#0a0a0f]" id="main-workspace-wrapper">
             
             <!-- COMMON MOBILE HEADER -->
             <div class="lg:hidden h-16 glass-panel border-b border-white/5 flex items-center px-4 justify-between z-30 relative">
                <button id="toggle-sidebar-btn" class="text-slate-400 p-2 hover:bg-white/10 rounded-xl transition-colors active:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                <span id="mobile-header-title" class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-300 text-xs tracking-[0.2em] uppercase">V19 ID PHOTO</span>
                <div class="relative">
                    <!-- ID Mode Mobile Download -->
                    <button id="mobile-download-trigger" class="p-2.5 bg-indigo-500/20 text-indigo-400 rounded-xl border border-indigo-500/30 transition-all opacity-50 cursor-not-allowed active:scale-95" disabled><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>
                    <div id="mobile-download-menu" class="absolute right-0 top-full mt-3 w-52 glass-panel rounded-xl shadow-2xl hidden overflow-hidden ring-1 ring-white/10 origin-top-right transform transition-all z-50">
                        <button id="mobile-dl-result" class="w-full text-left px-4 py-3 text-[11px] text-slate-300 hover:bg-indigo-600 hover:text-white transition-colors border-b border-white/5 flex items-center gap-2">Lưu Kết Quả (.PNG)</button>
                        <button id="mobile-dl-compare" class="w-full text-left px-4 py-3 text-[11px] text-slate-300 hover:bg-indigo-600 hover:text-white transition-colors border-b border-white/5 flex items-center gap-2">Lưu So Sánh</button>
                    </div>
                </div>
            </div>

            <!-- MODE 1: ID PHOTO WORKSPACE (Existing) -->
            <div id="mode-id-photo" class="flex-1 flex flex-col relative overflow-hidden h-full w-full">
                <div class="absolute top-6 left-6 right-6 h-14 glass-panel rounded-full flex items-center justify-between px-5 z-20 shadow-lg hidden sm:flex ring-1 ring-white/5">
                    <div class="flex items-center gap-4">
                        <div class="flex bg-black/10 rounded-full p-1 gap-1 border border-white/5">
                            <button id="view-slider" class="p-2 rounded-full text-white bg-white/10 shadow-sm ring-1 ring-white/5 transition-all hover:bg-white/20"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg></button>
                            <button id="view-split" class="p-2 rounded-full text-slate-500 hover:text-white hover:bg-white/5 transition-all"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path></svg></button>
                        </div>
                        <div class="text-[10px] text-slate-300 font-mono border border-white/5 px-4 py-2 rounded-full bg-black/10 flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>ZOOM: <span id="zoom-level" class="text-white font-bold">100%</span></div>
                        <div id="res-display" class="hidden sm:flex text-[10px] text-slate-400 font-mono border border-white/5 px-4 py-2 rounded-full bg-black/10 items-center gap-2 opacity-50"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg><span id="res-text">-- x --</span></div>
                        <button id="rotate-btn" class="p-2 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="help-btn" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white transition text-[12px] font-bold cursor-pointer shadow-sm">?</button>
                        <div class="flex bg-black/10 rounded-full p-1 gap-1 border border-white/5">
                            <button id="zoom-out" class="p-2 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg></button>
                            <button id="zoom-reset" class="px-3 hover:bg-white/10 rounded-full text-slate-400 hover:text-white text-[10px] font-bold transition">FIT</button>
                            <button id="zoom-in" class="p-2 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button>
                        </div>
                        <div class="relative ml-2 group">
                            <button id="download-trigger" class="flex items-center gap-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white hover:shadow-lg hover:scale-105 px-6 py-2.5 rounded-full text-xs font-bold transition-all opacity-50 cursor-not-allowed border border-white/10 active:scale-95" disabled><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>LƯU ẢNH</span></button>
                            <div id="download-menu" class="absolute right-0 mt-3 w-64 glass-panel rounded-2xl shadow-2xl hidden z-50 overflow-hidden ring-1 ring-white/10 backdrop-blur-xl">
                                <div class="p-4 border-b border-white/5">
                                    <span class="text-[9px] uppercase font-bold text-slate-500 block mb-2 tracking-wider">Định dạng lưu</span>
                                    <div class="flex bg-black/20 rounded-xl p-1 border border-white/5">
                                        <button id="fmt-png" class="flex-1 py-1.5 rounded-lg text-[10px] font-bold transition-all bg-indigo-600 text-white shadow-sm">PNG (Gốc)</button>
                                        <button id="fmt-jpg" class="flex-1 py-1.5 rounded-lg text-[10px] font-bold text-slate-500 hover:text-slate-300 transition-all">JPG (Nhẹ)</button>
                                    </div>
                                </div>
                                <button id="download-result" class="w-full text-left px-5 py-4 text-[11px] text-slate-300 hover:bg-white/5 hover:text-white transition-colors flex items-center gap-3">Lưu Kết Quả</button>
                                <button id="download-compare" class="w-full text-left px-5 py-4 text-[11px] text-slate-300 hover:bg-white/5 hover:text-white border-t border-white/5 transition-colors flex items-center gap-3">Lưu So Sánh (Pro)</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 relative flex items-center justify-center overflow-hidden perspective-1000">
                    <div id="canvas-scale-container" class="relative transition-transform duration-500 ease-[cubic-bezier(0.19,1,0.22,1)] origin-center will-change-transform" style="transform: scale(1);">
                        <div id="scan-beam" class="scan-beam"></div>
                        <div id="main-comparison-container" class="relative rounded-2xl shadow-2xl overflow-hidden border border-white/10 bg-[#0f172a] max-w-[95vw] max-h-[80vh] group ring-1 ring-white/5 hidden">
                            <img id="main-comparison-base-image" src="" class="block max-w-full max-h-[80vh] object-contain select-none pointer-events-none">
                            <div id="main-comparison-top" class="absolute top-0 left-0 h-full w-1/2 overflow-hidden select-none pointer-events-none border-r border-white/20 shadow-[5px_0_20px_rgba(0,0,0,0.5)]"><div id="main-canvas-wrapper" class="absolute top-0 left-0 h-full"><canvas id="main-canvas" class="w-full h-full object-contain"></canvas></div></div>
                            <div id="main-comparison-slider" class="absolute top-0 bottom-0 w-12 -ml-6 cursor-col-resize z-30 flex justify-center group select-none" style="left: 50%;">
                                <div class="w-[1px] h-full bg-white/40 transition-all duration-200 ease-out group-hover:bg-white/80 group-hover:shadow-[0_0_15px_rgba(255,255,255,0.8)]"></div>
                                <div class="absolute bottom-8 w-10 h-10 bg-white/10 backdrop-blur-xl border border-white/40 rounded-full flex items-center justify-center transition-transform duration-200 group-hover:scale-110 group-hover:bg-white/20 shadow-xl"><svg class="w-5 h-5 text-white drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg></div>
                            </div>
                            <div id="ai-terminal-overlay" class="absolute inset-0 z-50 bg-[#0f0c29]/90 backdrop-blur-lg hidden flex flex-col items-center justify-center font-mono">
                                <div class="w-full max-w-md p-8 rounded-3xl border border-white/10 bg-white/5 shadow-2xl relative overflow-hidden">
                                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-purple-500 to-transparent animate-scan opacity-70"></div>
                                    <div class="flex items-center gap-3 mb-6 border-b border-white/5 pb-4"><div class="w-3 h-3 rounded-full bg-red-400 animate-pulse"></div><div class="w-3 h-3 rounded-full bg-yellow-400"></div><div class="w-3 h-3 rounded-full bg-green-400"></div><span class="ml-auto text-[10px] text-purple-300 font-bold tracking-widest flex items-center gap-2"><span class="w-1.5 h-1.5 bg-purple-400 rounded-full animate-ping"></span>AI CORE ACTIVE</span></div>
                                    <div id="terminal-content" class="text-xs space-y-3 h-40 overflow-hidden scroll-smooth"></div>
                                    <div class="mt-6 border-t border-white/5 pt-4"><div class="flex justify-between text-[10px] text-purple-300 font-bold mb-2"><span>TIẾN TRÌNH</span><span id="term-percent">0%</span></div><div class="w-full bg-white/5 h-2 rounded-full overflow-hidden"><div id="term-progress-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 w-0 shadow-[0_0_15px_#a855f7] transition-all duration-300 ease-out"></div></div></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="placeholder-state" onclick="document.getElementById('image-upload').click()" class="text-center p-24 border-2 border-dashed border-indigo-500/20 rounded-[3rem] bg-white/[0.02] hover:bg-white/[0.04] transition-all duration-500 animate-float backdrop-blur-sm cursor-pointer hover:border-indigo-500/50 hover:shadow-[0_0_30px_rgba(99,102,241,0.1)] group">
                            <div class="w-32 h-32 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 rounded-full flex items-center justify-center mx-auto mb-8 text-indigo-300 group-hover:text-indigo-200 group-hover:scale-110 transition-all shadow-inner border border-white/5"><svg class="w-14 h-14 opacity-70 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg></div>
                            <h3 class="text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-white via-indigo-200 to-purple-200 tracking-tight mb-4 font-sans drop-shadow-sm opacity-20 md:opacity-100 group-hover:opacity-100 transition-opacity">STUDIO V19</h3>
                            <p class="text-sm text-slate-400 font-medium tracking-widest uppercase mb-4 group-hover:text-white transition-colors">Bấm để tải ảnh, Kéo thả hoặc Dán vào đây</p>
                        </div>
                        
                        <div id="error-message" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#0f0c29]/95 backdrop-blur-xl text-white px-10 py-10 rounded-[2rem] shadow-2xl z-50 hidden max-w-md text-center border border-red-500/30 scale-95 transition-transform duration-300">
                            <div class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6 text-red-400 border border-red-500/20"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                            <div class="font-bold text-xl uppercase mb-3 text-red-200">Lỗi Hệ Thống</div>
                            <span id="error-text" class="text-sm font-medium text-slate-400 block mb-8 leading-relaxed"></span>
                            <button onclick="document.getElementById('error-message').classList.add('hidden')" class="w-full py-3.5 bg-white/5 hover:bg-white/15 rounded-xl text-xs uppercase tracking-widest transition text-white font-bold border border-white/10">Đóng lại</button>
                        </div>
                        
                        <div id="help-modal" class="fixed inset-0 bg-[#0f0c29]/90 z-[100] hidden flex items-center justify-center backdrop-blur-lg transition-opacity duration-300" onclick="this.classList.add('hidden')">
                            <div class="bg-slate-900/80 p-12 rounded-[2.5rem] border border-white/10 max-w-md shadow-2xl transform transition-all scale-100" onclick="event.stopPropagation()">
                                <h3 class="text-sm font-black mb-8 text-white uppercase tracking-[0.25em] border-b border-white/5 pb-6 text-center">Phím Tắt</h3>
                                <ul class="space-y-6 text-xs text-slate-400 font-mono">
                                    <li class="flex justify-between items-center"><span>Ctrl + V</span> <span class="text-indigo-300 bg-indigo-500/10 border border-indigo-500/20 px-3 py-1.5 rounded-lg">Dán ảnh</span></li>
                                    <li class="flex justify-between items-center"><span>Giữ Space</span> <span class="text-slate-300 bg-slate-500/10 border border-slate-500/20 px-3 py-1.5 rounded-lg">Xem ảnh gốc</span></li>
                                    <li class="flex justify-between items-center"><span>Phím R</span> <span class="text-slate-300 bg-white/5 border border-white/10 px-3 py-1.5 rounded-lg">Xoay 90°</span></li>
                                    <li class="flex justify-between items-center"><span>Phím F</span> <span class="text-slate-300 bg-white/5 border border-white/10 px-3 py-1.5 rounded-lg">Toàn màn hình</span></li>
                                    <li class="flex justify-between items-center"><span>Enter</span> <span class="text-emerald-300 bg-emerald-500/10 border border-emerald-500/20 px-3 py-1.5 rounded-lg">Tạo ảnh</span></li>
                                </ul>
                                <button onclick="document.getElementById('help-modal').classList.add('hidden')" class="mt-10 w-full py-4 bg-white/5 hover:bg-white/10 rounded-2xl text-xs text-white font-bold tracking-wider transition border border-white/5">ĐÃ HIỂU</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="history-filmstrip-container" class="absolute bottom-0 left-0 w-full bg-[#0f172a]/90 backdrop-blur-xl border-t border-white/10 z-40 h-36 flex flex-col hidden transition-transform duration-500 translate-y-full shadow-[0_-20px_50px_rgba(0,0,0,0.5)]">
                     <div class="flex items-center justify-between px-6 py-3 bg-white/[0.02] border-b border-white/5"><span class="text-[11px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><svg class="w-3.5 h-3.5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Lịch sử tạo</span><button id="close-history" class="text-slate-500 hover:text-white transition p-1 bg-white/5 rounded-full"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button></div>
                     <div id="history-list" class="flex-1 overflow-x-auto flex items-center p-4 gap-4 scroll-smooth"><div class="text-[11px] text-slate-500 italic pl-4 font-medium">Chưa có ảnh nào...</div></div>
                 </div>
                <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 glass-panel px-8 py-3 rounded-full border border-white/10 z-20 flex gap-8 text-[11px] sm:text-xs text-slate-300 whitespace-nowrap shadow-2xl transition-all duration-500 hover:bg-black/40 hover:scale-105" id="canvas-controls" style="display:none;">
                    <button id="btn-hold-compare" class="hover:text-white flex items-center gap-3 active:text-slate-400 transition outline-none group"><div class="w-2 h-2 rounded-full bg-slate-500 group-hover:bg-indigo-400 group-hover:shadow-[0_0_15px_#818cf8] transition-all"></div><span class="hidden sm:inline tracking-wide font-medium">Giữ <b>Space</b> để so sánh</span></button><div class="w-px h-4 bg-white/10"></div><button id="toggle-history-btn" class="hover:text-white flex items-center gap-2 active:text-slate-400 transition outline-none group"><svg class="w-4 h-4 group-hover:text-purple-300 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg><span class="hidden sm:inline tracking-wide font-medium">Lịch sử</span></button>
                </div>
            </div>
            
            <!-- MODE 2: VISA PHOTO WORKSPACE (Hidden by default) -->
            <div id="mode-visa-photo" class="hidden flex-1 flex flex-col relative items-center justify-center p-6 h-full w-full overflow-hidden">
                <!-- Info Header for Visa Mode -->
                <div class="absolute top-6 left-1/2 transform -translate-x-1/2 z-20 bg-blue-500/20 backdrop-blur-md border border-blue-500/30 px-6 py-2 rounded-full flex items-center gap-3">
                    <span id="visa-flag-icon" class="text-xl">🇺🇸</span>
                    <span id="visa-country-info" class="text-xs font-bold text-white uppercase tracking-wide">Mỹ (USA) - 51x51mm</span>
                </div>

                <!-- Visa Editor Container -->
                <div class="relative bg-white/5 border-2 border-dashed border-white/10 rounded-2xl flex flex-col items-center justify-center p-1 transition-all" id="visa-placeholder">
                    <!-- If no image -->
                    <div id="visa-upload-state" class="p-12 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-white/5 transition-colors rounded-xl w-80 h-96">
                        <div class="w-16 h-16 rounded-full bg-blue-500/20 flex items-center justify-center mb-4 text-blue-400">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        </div>
                        <h4 class="font-bold text-slate-200">Tải Ảnh Chân Dung</h4>
                        <p class="text-xs text-slate-500 mt-2">Nên dùng ảnh gốc, chụp thẳng</p>
                        <input type="file" id="visa-upload-input" accept="image/*" class="hidden">
                    </div>

                    <!-- Editor State (Hidden initially) -->
                    <div id="visa-editor-container" class="hidden relative overflow-hidden bg-white shadow-2xl cursor-move" style="width: 320px; height: 320px;">
                        <!-- Radar Scan Effect -->
                        <div id="visa-radar-overlay" class="visa-radar"></div>

                        <!-- Image Layer -->
                        <img id="visa-editor-img" src="" class="absolute origin-center max-w-none select-none pointer-events-none" style="top: 50%; left: 50%;">
                        
                        <!-- Overlay Guides (Updated for High Visibility) -->
                        <div class="absolute inset-0 pointer-events-none z-10">
                            <!-- Center Line -->
                            <div class="absolute top-0 bottom-0 left-1/2 w-[1px] bg-cyan-400 shadow-[0_0_8px_cyan]"></div>
                            
                            <!-- Head Oval -->
                            <div id="visa-guide-oval" class="absolute border-[3px] border-dashed rounded-[50%] left-1/2 -translate-x-1/2 -translate-y-1/2 transition-all duration-300 visa-guide-high-viz"></div>
                            
                            <!-- Top Head Line -->
                            <div id="visa-guide-top" class="absolute w-1/3 h-[2px] border-t-2 border-dashed left-1/2 -translate-x-1/2 visa-guide-high-viz"></div>
                            <span id="visa-guide-top-label" class="absolute left-[65%] text-[10px] text-white visa-guide-label-box">ĐỈNH ĐẦU</span>

                            <!-- Eye Line -->
                            <div id="visa-guide-eye" class="absolute w-full h-[2px] border-t-2 border-dashed left-0 visa-guide-high-viz"></div>
                            <span id="visa-guide-eye-label" class="absolute right-2 text-[10px] text-white visa-guide-label-box">MẮT</span>
                            
                            <!-- Chin Line -->
                            <div id="visa-guide-chin" class="absolute w-1/3 h-[2px] border-t-2 border-solid left-1/2 -translate-x-1/2 visa-guide-high-viz"></div>
                             <span id="visa-guide-chin-label" class="absolute left-[65%] text-[10px] text-white visa-guide-label-box">CẰM</span>
                        </div>
                    </div>
                </div>

                <!-- Tools Overlay for Visa (Updated for Mobile Zoom Slider) -->
                <div id="visa-tools-overlay" class="absolute bottom-10 flex flex-col items-center gap-4 hidden w-full px-10">
                    <!-- NEW: Mobile Zoom Slider Overlay -->
                    <div class="w-full max-w-xs bg-black/40 backdrop-blur-md rounded-xl p-3 border border-white/10 flex items-center gap-3">
                         <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                         <input type="range" id="visa-mobile-zoom-slider" min="0.1" max="3" step="0.01" value="1" class="w-full h-1 bg-white/30 rounded-lg appearance-none cursor-pointer accent-white">
                         <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                    </div>

                    <button id="visa-change-img-btn" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-full text-xs font-bold text-white backdrop-blur-md border border-white/10 flex items-center gap-2">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Đổi Ảnh
                    </button>
                </div>
            </div>

            <!-- MODE 3: VIDEO COMPARE PRO (NEW) -->
             <div id="mode-video-compare" class="hidden flex-1 flex flex-col relative overflow-hidden h-full w-full bg-slate-900">
                <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 pb-20">
                        <!-- HEADER: MOBILE FIXED FLEX WRAP -->
                        <div class="lg:col-span-12 flex flex-col sm:flex-row items-start sm:items-center justify-between border-b border-slate-700 pb-4 mt-2 gap-3">
                             <div class="flex items-center space-x-2">
                                <svg class="text-green-500 w-8 h-8 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                                <div>
                                   <h1 class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-green-400 to-emerald-600 bg-clip-text text-transparent">Video So Sánh Pro</h1>
                                   <div class="flex items-center text-[10px] sm:text-xs text-green-400 mt-1"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Đã thêm: Chế độ ảnh gốc & Co giãn thông minh</div>
                                </div>
                             </div>
                             <button id="vid-reset-btn" class="w-full sm:w-auto flex items-center justify-center px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg border border-slate-600 transition-colors text-sm hover:text-white">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Reset
                             </button>
                        </div>

                        <!-- SETTINGS COLUMN -->
                        <div class="lg:col-span-4 space-y-6">
                            <!-- Image Uploads -->
                            <div class="bg-slate-800 p-5 rounded-xl border border-slate-700 shadow-lg">
                                <h2 class="font-semibold mb-4 flex items-center text-sm uppercase tracking-wider text-slate-300"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg> Tải Hình Ảnh</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 mb-2">1. ẢNH GỐC (ORIGINAL)</label>
                                        <div class="video-thumb-container h-24 rounded-lg flex items-center justify-center cursor-pointer group" onclick="document.getElementById('vid-up-org').click()">
                                            <input type="file" id="vid-up-org" class="hidden" accept="image/*">
                                            <img id="vid-prev-org" class="h-full w-full object-cover opacity-60 hidden group-hover:opacity-100 transition-opacity">
                                            <div id="vid-placeholder-org" class="text-center text-slate-500"><svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>Chọn ảnh gốc</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 mb-2">2. ẢNH ĐÃ SỬA (EDITED)</label>
                                        <div class="video-thumb-container h-24 rounded-lg flex items-center justify-center cursor-pointer group" onclick="document.getElementById('vid-up-edit').click()">
                                            <input type="file" id="vid-up-edit" class="hidden" accept="image/*">
                                            <img id="vid-prev-edit" class="h-full w-full object-cover opacity-60 hidden group-hover:opacity-100 transition-opacity">
                                            <div id="vid-placeholder-edit" class="text-center text-slate-500"><svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>Chọn ảnh sửa</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Layout & Watermark -->
                            <div class="bg-slate-800 p-5 rounded-xl border border-slate-700 shadow-lg">
                                <h2 class="font-semibold mb-4 flex items-center text-sm uppercase tracking-wider text-slate-300"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg> Bố Cục & Chữ Ký</h2>
                                
                                <div class="mb-6">
                                    <label class="block text-xs text-slate-400 mb-2 uppercase font-bold">Tỉ lệ khung hình</label>
                                    <div class="grid grid-cols-4 gap-2">
                                        <button class="vid-ratio-btn col-span-2 py-2 rounded-lg border text-[10px] font-bold uppercase transition-all vid-active-btn" data-ratio="original">Gốc (Auto)</button>
                                        <button class="vid-ratio-btn py-2 rounded-lg border text-[10px] font-bold uppercase transition-all vid-inactive-btn" data-ratio="9:16">9:16</button>
                                        <button class="vid-ratio-btn py-2 rounded-lg border text-[10px] font-bold uppercase transition-all vid-inactive-btn" data-ratio="16:9">16:9</button>
                                    </div>
                                    <div id="vid-scale-opts" class="hidden mt-3 animate-fadeIn">
                                        <div class="grid grid-cols-2 gap-2">
                                            <button class="vid-scale-btn py-2 rounded-lg border text-xs transition-all vid-inactive-btn" data-scale="cover">Lấp đầy (Cắt)</button>
                                            <button class="vid-scale-btn py-2 rounded-lg border text-xs transition-all vid-active-btn" data-scale="contain">Vừa khít</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="border-t border-slate-700 pt-4">
                                     <div class="flex bg-slate-900 p-1 rounded-lg mb-4">
                                        <button id="btn-logo-text" class="flex-1 py-2 text-xs font-bold rounded-md transition-all bg-blue-600 text-white shadow">Chữ Kẻ Chéo</button>
                                        <button id="btn-logo-image" class="flex-1 py-2 text-xs font-bold rounded-md transition-all text-slate-400 hover:text-white">Logo Ảnh</button>
                                     </div>
                                     
                                     <!-- Text Watermark Options -->
                                     <div id="wm-text-opts" class="space-y-3">
                                         <input type="text" id="wm-text-input" value="CHƯA THANH TOÁN" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs focus:border-blue-500 outline-none placeholder-slate-500" placeholder="Nhập tên/SĐT...">
                                         <div class="grid grid-cols-3 gap-2">
                                             <button class="wm-style-btn px-1 py-2 text-[10px] rounded border flex flex-col items-center justify-center vid-active-btn" data-style="remini">Lưới Kẻ</button>
                                             <button class="wm-style-btn px-1 py-2 text-[10px] rounded border flex flex-col items-center justify-center vid-inactive-btn" data-style="mixed">Caro</button>
                                             <button class="wm-style-btn px-1 py-2 text-[10px] rounded border flex flex-col items-center justify-center vid-inactive-btn" data-style="stroke">Đều</button>
                                         </div>
                                         <div>
                                            <label class="block text-xs text-slate-400 mb-1 flex justify-between"><span>Độ đậm</span><span id="wm-opacity-val">80%</span></label>
                                            <input type="range" id="wm-opacity" min="5" max="100" step="5" value="80" class="w-full accent-blue-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                         </div>
                                     </div>

                                     <!-- Image Logo Options -->
                                     <div id="wm-image-opts" class="hidden space-y-3">
                                         <input type="file" id="vid-up-logo" accept="image/*" class="block w-full text-xs text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                                         <div class="grid grid-cols-2 gap-2">
                                             <select id="wm-logo-pos" class="bg-slate-700 border border-slate-600 text-white text-xs rounded-md p-2">
                                                 <option value="bottom-right">Dưới Phải</option>
                                                 <option value="top-left">Trên Trái</option>
                                                 <option value="top-right">Trên Phải</option>
                                                 <option value="bottom-left">Dưới Trái</option>
                                             </select>
                                             <input type="range" id="wm-logo-size" min="5" max="50" value="15" class="w-full accent-yellow-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer self-center">
                                         </div>
                                     </div>
                                </div>
                            </div>
                            
                            <!-- Animation Settings -->
                            <div class="bg-slate-800 p-5 rounded-xl border border-slate-700 shadow-lg">
                                 <h2 class="font-semibold mb-4 flex items-center text-sm uppercase tracking-wider text-slate-300"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg> Hiệu Ứng</h2>
                                 <div class="grid grid-cols-3 gap-2 mb-4">
                                     <button class="vid-anim-btn flex flex-col items-center justify-center py-2 text-[10px] rounded-md border vid-active-btn" data-anim="scan-h">Quét Ngang</button>
                                     <button class="vid-anim-btn flex flex-col items-center justify-center py-2 text-[10px] rounded-md border vid-inactive-btn" data-anim="scan-v">Quét Dọc</button>
                                     <button class="vid-anim-btn flex flex-col items-center justify-center py-2 text-[10px] rounded-md border vid-inactive-btn" data-anim="fade">Biến Hình</button>
                                 </div>
                                 <div class="mb-4">
                                     <label class="block text-xs text-slate-400 mb-1">Tốc độ: <span id="anim-dur-val">3.0s</span></label>
                                     <input type="range" id="anim-dur" min="1" max="10" step="0.5" value="3.0" class="w-full accent-green-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                 </div>
                                 <div>
                                     <label class="block text-xs text-slate-400 mb-1">Nghỉ: <span id="anim-pause-val">1.0s</span></label>
                                     <input type="range" id="anim-pause" min="0" max="3" step="0.5" value="1.0" class="w-full accent-purple-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                 </div>
                            </div>
                        </div>

                        <!-- CANVAS & PREVIEW -->
                        <div class="lg:col-span-8 flex flex-col space-y-4">
                            <div class="flex gap-3">
                                <button id="vid-play-btn" class="flex-1 flex items-center justify-center py-3 rounded-lg font-bold transition-all bg-slate-700 text-slate-500 cursor-not-allowed text-xs sm:text-base" disabled>
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <span id="vid-play-text">Chạy Thử</span>
                                </button>
                                <button id="vid-export-btn" class="flex-1 flex items-center justify-center py-3 rounded-lg font-bold transition-all bg-slate-700 text-slate-500 cursor-not-allowed overflow-hidden relative text-xs sm:text-base" disabled>
                                    <div id="vid-export-prog" class="absolute inset-0 bg-green-700 transition-all duration-300 w-0 opacity-30"></div>
                                    <span id="vid-export-text" class="relative z-10 flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> Tải Video (Ổn Định)</span>
                                </button>
                            </div>
                            
                            <!-- MOBILE FIX: Adjusted min-height for mobile -->
                            <div class="flex-grow bg-black rounded-xl border border-slate-700 overflow-hidden relative shadow-2xl flex items-center justify-center min-h-[250px] sm:min-h-[400px]">
                                <div id="vid-canvas-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 pointer-events-none z-10 p-4 text-center">
                                    <div class="w-16 h-16 border-2 border-dashed border-slate-600 rounded-full flex items-center justify-center mb-3"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg></div>
                                    <p class="text-sm sm:text-base">Vui lòng tải ảnh lên để bắt đầu</p>
                                </div>
                                <canvas id="video-compare-canvas" class="max-w-full max-h-[70vh] object-contain shadow-lg hidden"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
             </div>

        </main>
        
        <!-- UPDATED: UNIFIED MOBILE SAVE/SHARE MODAL FOR IMAGE & VIDEO -->
        <div id="mobile-save-modal" class="fixed inset-0 z-[110] hidden bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center p-4 animate-fade-in">
            <div class="absolute top-4 right-4 z-50">
                <button id="close-mobile-save" class="p-3 bg-white/10 rounded-full text-white/70 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="w-full max-w-md flex flex-col items-center gap-6">
                <h3 id="mobile-modal-title" class="text-white font-bold text-lg uppercase tracking-wider text-center">Lưu & Chia Sẻ</h3>
                
                <div class="relative rounded-2xl overflow-hidden shadow-2xl border border-white/10 group w-full flex items-center justify-center bg-black/50" style="min-height: 200px;">
                     <!-- Image Preview -->
                     <img id="mobile-save-img" src="" class="max-h-[60vh] w-auto object-contain hidden">
                     <!-- Video Preview -->
                     <video id="mobile-save-video" controls playsinline loop class="max-h-[60vh] w-auto object-contain hidden"></video>
                </div>

                <div class="flex flex-col w-full gap-3">
                    <button id="mobile-share-btn" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-blue-600/30">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                        LƯU VÀO ĐIỆN THOẠI / CHIA SẺ
                    </button>
                    <p id="mobile-modal-desc" class="text-slate-400 text-xs text-center px-4">
                        Bấm nút trên và chọn <b>"Lưu hình ảnh"</b> hoặc <b>"Lưu Video"</b>.
                    </p>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL HELPERS & STATE ---
            const safeAdd = (el, evt, fn) => { if (el) el.addEventListener(evt, fn); };
            const showToast = (message, type = 'info') => {
                const container = document.getElementById('toast-container'); const toast = document.createElement('div'); let icon = '', colors = '';
                if (type === 'error') { icon = '<svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'; colors = 'bg-red-900/90 border-red-500/30 text-red-100'; } 
                else if (type === 'success') { icon = '<svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'; colors = 'bg-emerald-900/90 border-emerald-500/30 text-emerald-100'; } 
                else { icon = '<svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'; colors = 'bg-slate-800/90 border-slate-600/30 text-slate-200'; }
                toast.className = `flex items-center gap-4 px-5 py-4 rounded-2xl border backdrop-blur-md shadow-2xl animate-toast-in ${colors}`; toast.innerHTML = `${icon}<span class="text-xs font-bold tracking-wide">${message}</span>`; container.appendChild(toast);
                setTimeout(() => { toast.style.animation = 'toastOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards'; setTimeout(() => toast.remove(), 300); }, 3000);
            };

            // --- MODE SWITCHER LOGIC ---
            window.switchMode = (mode) => {
                const btnId = document.getElementById('btn-mode-id');
                const btnVisa = document.getElementById('btn-mode-visa');
                const btnVideo = document.getElementById('btn-mode-video');
                
                const sideId = document.getElementById('sidebar-content-id');
                const sideVisa = document.getElementById('sidebar-content-visa');
                
                const workId = document.getElementById('mode-id-photo');
                const workVisa = document.getElementById('mode-visa-photo');
                const workVideo = document.getElementById('mode-video-compare');
                const mobileTitle = document.getElementById('mobile-header-title');

                // Reset all
                [btnId, btnVisa, btnVideo].forEach(b => b && b.classList.replace('mode-active', 'mode-inactive'));
                [sideId, sideVisa].forEach(s => s && s.classList.add('hidden'));
                [workId, workVisa, workVideo].forEach(w => w && w.classList.add('hidden'));

                // MOBILE FIX: Auto close sidebar on mobile when switching modes
                if (window.innerWidth < 1024) {
                     const sidebar = document.getElementById('sidebar');
                     if (sidebar) sidebar.classList.add('-translate-x-full');
                }

                if (mode === 'id') {
                    btnId.classList.replace('mode-inactive', 'mode-active');
                    sideId.classList.remove('hidden');
                    workId.classList.remove('hidden');
                    if(mobileTitle) mobileTitle.textContent = "V19 ID PHOTO";
                } else if (mode === 'visa') {
                    btnVisa.classList.replace('mode-inactive', 'mode-active');
                    sideVisa.classList.remove('hidden');
                    workVisa.classList.remove('hidden');
                    if(mobileTitle) mobileTitle.textContent = "V19 VISA PRO";
                } else if (mode === 'video') {
                    btnVideo.classList.replace('mode-inactive', 'mode-active');
                    workVideo.classList.remove('hidden');
                    if(mobileTitle) mobileTitle.textContent = "VIDEO COMPARE";
                }
            };

            // ==========================================
            // MODULE 1: ID PHOTO CORE (EXISTING LOGIC)
            // ==========================================
            const addToHistory = (imgObj) => { 
                const id = Date.now(); 
                state.history.push({ id, img: imgObj }); 
                if(state.history.length === 1 && els.historyList) els.historyList.innerHTML = ''; 
                const div = document.createElement('div'); 
                div.className = 'history-item relative w-24 h-24 flex-shrink-0 cursor-pointer rounded-2xl overflow-hidden border border-white/10 bg-black active group shadow-lg transition-all hover:scale-105 hover:border-indigo-500'; 
                div.dataset.id = id; 
                const cv = document.createElement('canvas'); 
                cv.width = 100; cv.height = 100; 
                const cx = cv.getContext('2d'); 
                const ratio = Math.max(100/imgObj.width, 100/imgObj.height); 
                const cw = imgObj.width*ratio; const ch = imgObj.height*ratio; 
                cx.drawImage(imgObj, (100-cw)/2, (100-ch)/2, cw, ch); 
                const imgEl = document.createElement('img'); 
                imgEl.src = cv.toDataURL(); 
                imgEl.className = 'w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity'; 
                div.appendChild(imgEl); 
                if(els.historyList) els.historyList.prepend(div); 
                document.querySelectorAll('.history-item').forEach(d => { d.classList.remove('ring-2', 'ring-indigo-500'); d.querySelector('img').classList.add('opacity-80'); }); 
                div.classList.add('ring-2', 'ring-indigo-500'); 
                imgEl.classList.remove('opacity-80'); 
                div.addEventListener('click', () => { 
                    document.querySelectorAll('.history-item').forEach(d => { d.classList.remove('ring-2', 'ring-indigo-500'); d.querySelector('img').classList.add('opacity-80'); }); 
                    div.classList.add('ring-2', 'ring-indigo-500'); 
                    div.querySelector('img').classList.remove('opacity-80'); 
                    const found = state.history.find(x => x.id === id); 
                    if(found) { state.restoredObj = found.img; render(); } 
                }); 
                toggleHistory(true); 
            };

            const toggleHistory = (show) => { 
                if(!els.historyContainer) return; 
                if(show) { 
                    els.historyContainer.classList.remove('hidden'); 
                    requestAnimationFrame(() => els.historyContainer.classList.remove('translate-y-full')); 
                    if(els.controls) els.controls.style.bottom = '10rem'; 
                } else { 
                    els.historyContainer.classList.add('translate-y-full'); 
                    setTimeout(() => els.historyContainer.classList.add('hidden'), 500); 
                    if(els.controls) els.controls.style.bottom = '2.5rem'; 
                } 
            };

            async function fetchWithRetry(url, payload, maxRetries = 5) {
                let delay = 1000;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error('Transient API error, retrying...');
                        }
                        const text = await response.text();
                        if (!response.ok) {
                            let errorMessage = `API Error: ${response.status}`;
                            try { const errorBody = JSON.parse(text); errorMessage = errorBody.error?.message || errorMessage; } catch (e) { if (text) errorMessage += ` - ${text}`; }
                            throw new Error(errorMessage);
                        }
                        if (!text) throw new Error("Empty response from server.");
                        return JSON.parse(text);
                    } catch (error) {
                        if (i < maxRetries - 1) { await new Promise(resolve => setTimeout(resolve, delay)); delay *= 2; } else { throw error; }
                    }
                }
            }

            const OUTFITS = {
                "cong-an": {
                    // ... existing cong-an items ...
                    id: "cong-an", label: "Công An Nhân Dân (Full Chuẩn)", icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>`,
                    items: [ 
                        { type: 'header', label: 'Học Viên & Hạ Sĩ Quan (Chiến Sĩ)' }, 
                        { name: "Học Viên (Cầu Vai Trơn)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An Nhân Dân Việt Nam (Vietnam People's Security uniform), áo màu xanh cỏ úa sẫm (dark olive green shirt), cầu vai đỏ trơn nhỏ gọn (small red epaulettes no stripes), ve áo đỏ có Công an hiệu nhỏ (small red collar badge), không đội mũ, nghiêm trang" }, 
                        { name: "Hạ Sĩ Quan (Gạch Vàng Chữ V)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An Việt Nam, áo xanh cỏ úa, cầu vai đỏ có gạch vàng hình chữ V nhỏ (red epaulettes with small yellow V-shaped stripes), ve áo đỏ nhỏ, nghiêm trang" },

                        { type: 'header', label: 'Sĩ Quan Cấp Úy (1 Gạch - Nền Vàng)' }, 
                        { name: "Thiếu Úy (1 Sao)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An Việt Nam, áo xanh cỏ úa, cầu vai nền vàng có 1 gạch đỏ dọc mảnh (thin red stripe) và 1 sao kim loại nhỏ (tiny silver star), ve áo đỏ gắn Công an hiệu nhỏ (small badge), sơ mi trắng, cà vạt xanh rêu (nếu có)" }, 
                        { name: "Trung Úy (2 Sao)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An Việt Nam, áo xanh cỏ úa, cầu vai nền vàng có 1 gạch đỏ dọc mảnh và 2 sao kim loại nhỏ (2 tiny silver stars), ve áo đỏ nhỏ (small collar badge), nghiêm trang" }, 
                        { name: "Thượng Úy (3 Sao)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An Việt Nam, áo xanh cỏ úa, cầu vai nền vàng có 1 gạch đỏ dọc mảnh và 3 sao kim loại nhỏ (3 tiny silver stars), ve áo đỏ nhỏ, tỉ lệ chuẩn" }, 
                        { name: "Đại Úy (4 Sao)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An Việt Nam, áo xanh cỏ úa, cầu vai nền vàng có 1 gạch đỏ dọc mảnh và 4 sao kim loại nhỏ (4 tiny silver stars), sắp xếp gọn gàng (neatly arranged), ve áo đỏ nhỏ" }, 

                        { type: 'header', label: 'Sĩ Quan Cấp Tá (2 Gạch - Nền Vàng)' }, 
                        { name: "Thiếu Tá (1 Sao Lớn)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An Việt Nam, áo xanh cỏ úa, cầu vai nền vàng có 2 gạch đỏ dọc mảnh (2 thin red stripes) và 1 sao lớn vừa phải (1 medium large star), không quá to (not oversized), ve áo đỏ đính cành tùng đơn nhỏ (small pine branch collar), nghiêm trang" }, 
                        { name: "Trung Tá (2 Sao Lớn)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An Việt Nam, áo xanh cỏ úa, cầu vai nền vàng có 2 gạch đỏ dọc mảnh và 2 sao lớn vừa phải (2 medium large stars), ve áo đỏ đính cành tùng đơn nhỏ (delicate pine branch)" }, 
                        { name: "Thượng Tá (3 Sao Lớn)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An Việt Nam, áo xanh cỏ úa, cầu vai nền vàng có 2 gạch đỏ dọc mảnh và 3 sao lớn vừa phải (3 medium large stars), ve áo đỏ đính cành tùng đơn nhỏ, tinh tế" }, 
                        { name: "Đại Tá (4 Sao Lớn)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An Việt Nam, áo xanh cỏ úa, cầu vai nền vàng có 2 gạch đỏ dọc mảnh và 4 sao lớn vừa phải (4 medium large stars), ve áo đỏ đính cành tùng đơn nhỏ, cân đối" }, 

                        { type: 'header', label: 'Sĩ Quan Cấp Tướng (Sao Vàng - Dệt Nổi)' }, 
                        { name: "Thiếu Tướng (1 Sao Vàng)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục cấp Tướng Công An Việt Nam, áo màu be hồng (hoặc trắng lễ phục), cầu vai đỏ viền vàng dệt vân nổi, 1 ngôi sao vàng 5 cánh kích thước chuẩn (1 standard gold star), không quá khổ (not huge), ve áo đỏ thêu cành tùng vàng nhỏ (small embroidered pine branch), nghiêm trang" }, 
                        { name: "Trung Tướng (2 Sao Vàng)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục cấp Tướng Công An Việt Nam, cầu vai đỏ viền vàng dệt vân nổi, 2 ngôi sao vàng 5 cánh kích thước chuẩn (2 standard gold stars), ve áo đỏ thêu cành tùng vàng nhỏ tinh tế" },
                        { name: "Thượng Tướng (3 Sao Vàng)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục cấp Tướng Công An Việt Nam, cầu vai đỏ viền vàng dệt vân nổi, 3 ngôi sao vàng 5 cánh kích thước chuẩn (3 standard gold stars), ve áo đỏ thêu cành tùng vàng nhỏ" },
                        { name: "Đại Tướng (4 Sao Vàng)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục cấp Tướng Công An Việt Nam, cầu vai đỏ viền vàng dệt vân nổi, 4 ngôi sao vàng 5 cánh kích thước chuẩn (4 standard gold stars), ve áo đỏ thêu cành tùng vàng nhỏ" },

                        { type: 'header', label: 'Cảnh Sát Giao Thông (CSGT)' }, 
                        { name: "CSGT (Áo Vàng - Không Mũ)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Cảnh Sát Giao Thông Việt Nam màu vàng lúa chín (Vietnam Traffic Police yellow uniform), cầu vai đỏ nhỏ, ve áo đỏ nhỏ, bảng tên xanh dương nhỏ (small blue name tag), dây chiến thắng gọn gàng, nghiêm trang" },
                        { name: "CSGT (Áo Vàng - Có Mũ)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục CSGT màu vàng, ĐỘI MŨ KÊ-PI VÀNG (wearing yellow peaked cap) có viền đỏ, gắn Công an hiệu kích thước chuẩn (standard size police badge), không quá to, cầu vai đỏ nhỏ, ve áo đỏ nhỏ" },

                        { type: 'header', label: 'Công An Có Mũ (Full Bộ)' },
                        { name: "Học Viên + Mũ Kê-pi", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An (áo xanh), ĐỘI MŨ KÊ-PI XANH (wearing green peaked cap), mũ có Công an hiệu nhỏ, cầu vai đỏ trơn, ve áo đỏ, nghiêm trang" },
                        { name: "Sĩ Quan (Úy/Tá) + Mũ Kê-pi", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Công An (áo xanh), ĐỘI MŨ KÊ-PI XANH SẪM (wearing dark olive peaked cap), vành mũ đỏ (red band), gắn Công an hiệu tròn chuẩn (standard round police badge), dây tết vàng nhỏ (thin gold cord), nghiêm trang" },
                        { name: "Cấp Tướng + Mũ Kê-pi", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục cấp Tướng (áo be/trắng), ĐỘI MŨ KÊ-PI CẤP TƯỚNG (wearing General peaked cap), vành mũ đỏ, mặt mũ bọc nỉ, gắn Quốc huy và cành tùng bao quanh (emblem with pine wreath), dây tết vàng nhỏ" },
                        { name: "Lễ Phục Trắng + Mũ Kê-pi", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc lễ phục Công An màu trắng (white ceremonial uniform), ĐỘI MŨ KÊ-PI TRẮNG TOÀN BỘ (wearing ALL WHITE peaked cap), không có viền đỏ (no red band), mũ màu trắng tinh (pure white cap), công an hiệu chuẩn, cà vạt đen, nghiêm trang" }
                    ]
                },
                "quan-doi": {
                    // ... existing quan-doi items ...
                    id: "quan-doi", label: "Quân Đội", icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>`,
                    items: [ 
                        { type: 'header', label: 'Lục Quân' }, 
                        { name: "Bộ đội: Lục quân (Thường phục)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục bộ đội Lục quân Việt Nam màu xanh ô liu (Vietnam People's Army K08 green uniform), cổ bẻ (K82 collar), ve áo nền đỏ hình ngôi sao vàng 5 cánh (red collar patches with 5-pointed gold star), mũ cứng hoặc mũ mềm có Quân hiệu Việt Nam (Vietnam Army Badge: red circle, gold star, wreath, NO TEXT, NO CHINESE CHARACTERS), nghiêm trang" }, 
                        { name: "Bộ đội: Sĩ quan Lục quân (Lễ phục)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc lễ phục sĩ quan Lục quân Việt Nam (Vietnam Army officer ceremonial uniform), cầu vai đỏ, ve áo đỏ có hình cành tùng vàng, đội mũ kê-pi quân đội màu xanh lá sẫm có Quân hiệu Việt Nam (red background, gold star, NO TEXT)" }, 
                        { type: 'header', label: 'Quân Chủng Khác' }, 
                        { name: "Hải quân (Trang phục trắng)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Hải quân Nhân dân Việt Nam (Vietnam People's Navy uniform), áo trắng, yếm xanh dương có sọc trắng (blue collar with white stripes), đội mũ dải yếm hải quân Việt Nam có chữ 'HẢI QUÂN' màu vàng (ONLY text 'HẢI QUÂN', NO Chinese characters)" }, 
                        { name: "Phòng không - Không quân", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc quân phục Phòng không - Không quân Việt Nam (Vietnam Air Defence - Air Force), áo màu xanh da trời nhạt, cầu vai và ve áo nền xanh da trời có sao/cành tùng chuẩn quân đội Việt Nam, nghiêm trang" }, 
                    ]
                },
                "vest-nam": {
                    // ... existing vest items ...
                    id: "vest-nam", label: "Vest Nam", icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>`,
                    items: [ { type: 'header', label: 'Vest Đen (Cà Vạt Đỏ & Vàng)' }, { name: "Vest Đen - Cà vạt Đỏ Đô", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest đen sang trọng (black suit), áo sơ mi trắng, thắt cà vạt màu đỏ đô (burgundy red tie), phong thái lãnh đạo" }, { name: "Vest Đen - Cà vạt Đỏ Tươi", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest đen sang trọng (black suit), áo sơ mi trắng, thắt cà vạt màu đỏ tươi (bright red tie), trẻ trung" }, { name: "Vest Đen - Cà vạt Vàng Đồng", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest đen sang trọng (black suit), áo sơ mi trắng, thắt cà vạt màu vàng đồng (gold tie), sang trọng" }, { type: 'header', label: 'Vest Đen (Cà Vạt Lạnh & Trầm)' }, { name: "Vest Đen - Cà vạt Xanh Dương", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest đen sang trọng (black suit), áo sơ mi trắng, thắt cà vạt màu xanh dương đậm (dark blue tie), lịch lãm" }, { name: "Vest Đen - Cà vạt Tím Than", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest đen sang trọng (black suit), áo sơ mi trắng, thắt cà vạt màu tím than (dark purple tie), chững chạc" }, { name: "Vest Đen - Cà vạt Xám Bạc", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest đen sang trọng (black suit), áo sơ mi trắng, thắt cà vạt màu xám bạc (silver grey tie), tinh tế" }, { type: 'header', label: 'Cà Vạt Họa Tiết' }, { name: "Vest Đen - Cà vạt Kẻ Sọc (Đỏ/Xanh)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest đen sang trọng (black suit), áo sơ mi trắng, thắt cà vạt kẻ sọc chéo đỏ xanh (striped red and blue tie)" }, { name: "Vest Đen - Cà vạt Kẻ Sọc (Vàng/Đen)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest đen sang trọng (black suit), áo sơ mi trắng, thắt cà vạt kẻ sọc vàng đen (striped gold and black tie)" }, { name: "Vest Đen - Cà vạt Chấm Bi", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest đen sang trọng (black suit), áo sơ mi trắng, thắt cà vạt chấm bi nhỏ (polka dot tie), cổ điển" }, { name: "Vest Đen - Cà vạt Hoa Văn Chìm", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest đen sang trọng (black suit), áo sơ mi trắng, thắt cà vạt hoa văn chìm (paisley pattern tie), nghệ thuật" }, { type: 'header', label: 'Vest Màu & Sơ Mi Cơ Bản' }, { name: "Vest Xám - Cà vạt Đen", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest màu xám ghi (grey suit), áo sơ mi trắng, thắt cà vạt đen trơn" }, { name: "Vest Navy - Cà vạt Vàng", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest màu xanh navy (navy blue suit), áo sơ mi trắng, thắt cà vạt vàng" }, { name: "Áo sơ mi xanh nhạt (Công sở)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi màu xanh dương nhạt (light blue office shirt), cổ cồn phẳng phiu" }, { type: 'header', label: 'Bộ Sưu Tập Sơ Mi Nam (Không Vest)' }, { name: "Sơ mi Trắng (Cổ Đức)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi trắng nam cổ đức (men formal white shirt), cổ cứng phẳng phiu, không vest, nghiêm túc" }, { name: "Sơ mi Xanh Dương (Blue)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi nam màu xanh dương (blue formal shirt), cổ đức, không vest, công sở" }, { name: "Sơ mi Xanh Nhạt (Sky Blue)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi nam màu xanh da trời nhạt (light sky blue formal shirt), cổ đức, không vest" }, { name: "Sơ mi Đen (Black)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi nam màu đen tuyền (black formal shirt), cổ đức, sang trọng, không vest" }, { name: "Sơ mi Xám Ghi (Grey)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi nam màu xám ghi (grey formal shirt), cổ đức, lịch sự, không vest" }, { name: "Sơ mi Đỏ Đô (Dark Red)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi nam màu đỏ đô (dark red burgundy formal shirt), cổ đức, không vest" }, { name: "Sơ mi Tím Than (Dark Purple)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi nam màu tím than (dark purple formal shirt), cổ đức, không vest" }, { name: "Sơ mi Hồng Nhạt (Light Pink)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi nam màu hồng nhạt (light pink formal shirt), cổ đức, trẻ trung, không vest" }, { name: "Sơ mi Kẻ Sọc (Striped)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi nam kẻ sọc dọc văn phòng (vertical striped formal shirt), cổ đức, không vest" } ]
                },
                "ao-dai": {
                    // ... existing ao-dai items ...
                    id: "ao-dai", label: "Nữ Giới & Áo Dài", icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>`,
                    items: [ 
                        { type: 'header', label: 'Công Sở & Vest' }, 
                        { name: "Áo sơ mi trắng (Nữ)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi trắng nữ cổ đức (formal white shirt for women), kín đáo" }, 
                        { name: "Áo vest nữ đen (Sang trọng)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo vest nữ màu đen (black blazer for women), bên trong là sơ mi trắng hoặc áo thun cổ tròn lịch sự" }, 
                        
                        { type: 'header', label: 'Áo Dài Truyền Thống (Trẻ & Trung)' }, 
                        { name: "Áo dài trắng cao cổ", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài lụa trắng trơn truyền thống Việt Nam (traditional white ao dai), cổ đứng cao kín đáo (high collar)" }, 
                        { name: "Áo dài đỏ đô (Lụa)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài lụa màu đỏ đô (dark red ao dai), cổ đứng cao kín đáo (high collar), sang trọng" }, 
                        { name: "Áo dài tím Huế (Lụa)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài lụa tím huế (purple silk ao dai), cổ cao truyền thống (high collar), quý phái" }, 
                        { name: "Áo dài xanh đậm", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài lụa màu xanh đậm truyền thống (dark blue ao dai), cổ đứng cao kín đáo (high collar)" }, 
                        { name: "Áo dài Gấm Vàng (Họa tiết)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài gấm màu vàng họa tiết đồng tiền (wearing yellow brocade ao dai with subtle patterns), cổ đứng cao kín đáo, sang trọng" }, 
                        { name: "Áo dài Hồng Cánh Sen", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài màu hồng cánh sen (wearing lotus pink ao dai), cổ đứng cao kín đáo, trẻ trung" }, 

                        { type: 'header', label: 'Áo Dài Nhung & Lớn Tuổi (Quý Phái)' },
                        { name: "Áo Nhung Đen (Cổ Ngọc Trai)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài nhung đen tuyền (black velvet ao dai), cổ kiềng đính ngọc trai (pearl neck), chất liệu nhung tuyết sang trọng, phù hợp bà sui/người lớn tuổi" },
                        { name: "Áo Nhung Đỏ Đậm (Đính Đá)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài nhung màu đỏ mận đậm (dark red burgundy velvet ao dai), cổ đính hạt cườm lấp lánh sang trọng (beaded collar), quý phái cho người trung niên" },
                        { name: "Áo Nhung Tím Than (Đậm)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài nhung màu tím than đậm (dark purple velvet ao dai), vải nhung tuyết dày dặn, cổ cao kín đáo, phong cách quý bà" },
                        { name: "Áo Nhung Xanh Rêu (Quý Phái)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài nhung màu xanh rêu đậm (dark moss green velvet ao dai), sang trọng, đằm thắm, phù hợp người lớn tuổi" },
                        { name: "Áo Nhung Đen (Họa Tiết Vàng)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài nhung đen có họa tiết hoa văn vàng kim loại (black velvet ao dai with gold patterns), sang trọng, quyền lực" },
                        { name: "Áo Gấm Nâu Đồng (Trầm)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài gấm màu nâu đồng hoặc vàng đồng đậm (dark bronze brocade ao dai), họa tiết chìm sang trọng, màu sắc nhã nhặn cho người lớn tuổi" },
                        { name: "Áo Dài Xanh Cổ Vịt (Đậm)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài màu xanh cổ vịt đậm (dark teal ao dai), vải dày dặn sang trọng, tôn da" },

                        { type: 'header', label: 'Trang Phục Khác' },
                        { name: "Áo bà ba (Truyền thống)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo bà ba màu nâu hoặc đen giản dị (traditional southern vietnam blouse), truyền thống" }, 
                        { name: "Áo Lam (Phật Tử)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo lam đi chùa (wearing traditional grey buddhist robe ao lam), cổ đứng kín đáo (high collar)" },
                        { name: "Áo Dài Trắng + Nón Lá", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo dài trắng truyền thống Việt Nam, đội nón lá (wearing traditional conical hat non la), duyên dáng, nền nã" }
                    ]
                },
                "trang-suc": {
                    id: "trang-suc", label: "Trang Sức (Giữ Áo)", icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                    items: [ 
                        { type: 'header', label: 'Ngọc Trai (Bộ Sưu Tập Mới)' },
                        { name: "Ngọc Trai (1 Sợi - Hạt Nhỏ)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo chuỗi ngọc trai hạt nhỏ bình thường (wearing normal small pearl necklace), hạt ngọc trai kích thước thật (realistic small size), tỉ lệ chuẩn với mặt (proportionate to face), nằm thấp trên ngực (resting low on chest), không bị to (not oversized), bông tai ngọc trai nhỏ" }, 
                        { name: "Ngọc Trai (Dáng Dài)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo chuỗi ngọc trai dáng dài (wearing long pearl necklace), hạt ngọc trai nhỏ tinh tế (delicate small beads), rủ sâu xuống ngực (hanging deep), dây mảnh (fine strand), phong cách quý bà cổ điển, bông tai ngọc trai" },
                        { name: "Ngọc Trai (2 Sợi - Sang Trọng)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo chuỗi ngọc trai 2 sợi hạt nhỏ (wearing double strand pearl necklace with SMALL beads), hạt ngọc trai bé (tiny pearls), nằm thấp dưới cổ, không bị to thô (not chunky), bông tai ngọc trai" },
                        { name: "Ngọc Trai (3 Sợi - Hoàng Gia)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo chuỗi ngọc trai 3 sợi hạt tấm (wearing triple strand pearl necklace with TINY SEED PEARLS), hạt siêu nhỏ (micro beads), 3 lớp mảnh mai (delicate layers), rủ mềm mại, không bó cổ, bông tai ngọc trai" },

                        { type: 'header', label: 'Vàng & Dây Mảnh (Đã Sửa Lại: Siêu Thấp)' }, 
                        { name: "Bộ Kiềng Vàng (Ôm Sát Chân Cổ)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo bộ vòng kiềng vàng cứng bản nhỏ (wearing THIN solid gold neck ring), nằm thấp đè nặng lên xương ức (resting HEAVY on sternum), không được hở cổ (no gap with skin), nằm sát chân cổ (sitting at very base of neck), có bóng đổ lên da (shadow on skin), bông tai vàng" }, 
                        { name: "Bộ Dây Chuyền Vàng + Đá", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo dây chuyền vàng sợi nhỏ tiêu chuẩn (wearing STANDARD THIN GOLD CHAIN), dây kim loại nặng rủ xuống xương ức (heavy metal chain hanging low to sternum), nằm ệp xuống ngực (laying FLAT against chest), ôm sát theo da thịt (contouring to skin), có bóng đổ dưới dây (shadow under chain), bông tai vàng" }, 
                        { name: "Dây Chuyền Vàng (Sợi Nhỏ Trơn)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo dây chuyền vàng trơn sợi nhỏ (wearing STANDARD THIN GOLD CHAIN), sợi dây mảnh mềm mại (soft limp chain), nằm rạp trên xương quai xanh (resting flush on collarbone), không có khe hở với da (no gap with skin), trọng lực kéo xuống (gravity pull), bông tai nụ nhỏ" },
                        
                        // MỚI: BỔ SUNG CÁC MẪU DÂY VÀNG NHỎ
                        { name: "Dây Chuyền Vàng (Dây Mì Xoắn)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo dây chuyền vàng sợi mì xoắn nhỏ (wearing delicate twisted gold rope chain), sợi dây xoắn nhuyễn (fine twisted links), rủ mềm mại trên ngực (soft drape on chest), lấp lánh nhẹ (subtle sparkle), bông tai vàng nhỏ" },
                        { name: "Dây Chuyền Vàng (Dây Bi Nhỏ)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo dây chuyền vàng hạt bi nhỏ (wearing gold bead chain necklace), chuỗi hạt bi vàng nhỏ li ti (tiny gold beads), sợi mảnh tinh tế (dainty), nằm thấp tự nhiên, bông tai nụ vàng" },
                        { name: "Dây Chuyền Vàng (Xích Vuông Mảnh)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo dây chuyền vàng mắt xích vuông nhỏ (wearing thin box chain necklace), mắt xích vuông mảnh (fine box links), dáng dây cứng cáp nhưng mảnh (sturdy but thin), nằm êm trên da, bông tai vàng" },
                        { name: "Dây Chuyền Vàng (Cỏ 4 Lá)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo dây chuyền vàng mặt cỏ 4 lá nhỏ (wearing thin gold chain with small four-leaf clover pendant), mặt dây nhỏ xinh (petite pendant), sợi dây siêu mảnh (whisper thin), phong cách trẻ trung, bông tai nhỏ" },
                        { name: "Dây Chuyền Vàng (Mặt Tim Nhỏ)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo dây chuyền vàng mặt tim nhỏ (wearing thin gold chain with small heart pendant), mặt tim vàng bé xíu (tiny heart), dây mảnh như chỉ (thread-like chain), nằm hõm cổ (resting in hollow of throat), bông tai tim nhỏ" },

                        { type: 'header', label: 'Đá Quý & Khác' },
                        { name: "Bộ Cẩm Thạch (Ngọc Bích)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo dây chuyền ngọc cẩm thạch xanh dây mảnh (wearing thin green jade necklace), mặt ngọc nhỏ vừa phải (medium small pendant), dây nằm sát da ngực (chain touching chest skin), có bóng đổ, bông tai cẩm thạch" }, 
                        { name: "Bộ Bạch Kim (Kim Cương)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo dây chuyền bạch kim mảnh sáng (wearing thin platinum chain), đính kim cương nhỏ (small diamond pendant), nằm thấp tự nhiên (natural low fit), bám sát cổ (hugging neck), tuyệt đối không bay, bông tai kim cương" }, 
                        { name: "Dây chuyền Mặt Phật", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo dây chuyền vàng sợi nhỏ mặt Phật (wearing STANDARD THIN GOLD CHAIN with small Buddha pendant), mặt Phật nhỏ (small pendant), nằm thấp trên ngực (heavy pendant on chest), dây bám sát da, không bị lật (no flip), có bóng đổ" }, 
                        { name: "Chuỗi tràng hạt (Gỗ)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo chuỗi tràng hạt gỗ hạt nhỏ (wearing small wooden buddhist prayer beads necklace), hạt gỗ nhỏ vừa vặn (realistic small beads), rủ xuống ngực (hanging on chest), bám sát cổ áo" }, 
                        { name: "Chuỗi Mân Côi (Công Giáo)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo chuỗi hạt Mân Côi Công Giáo hạt nhỏ (wearing thin catholic rosary beads necklace with small cross), hạt nhỏ tinh tế (delicate beads), rủ thấp xuống ngực, thánh giá nằm trên áo" }, 
                        
                        { type: 'header', label: 'Mắt Kính' }, 
                        { name: "Kính lão (Gọng vàng)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo kính lão gọng vàng mảnh (wearing thin gold rim reading glasses)" }, 
                        { name: "Kính lão (Gọng đen)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo kính lão gọng nhựa đen mỏng (wearing thin black frame reading glasses)" }, 
                        { name: "Kính cận (Kim loại)", value: "Quan trọng: Giữ nguyên quần áo hiện tại (keep current clothes unchanged), chỉ thêm phụ kiện: đeo kính cận gọng kim loại siêu mỏng (wearing ultra thin metal frame glasses)" } 
                    ]
                },
                "hoc-sinh": {
                    // ... existing hoc-sinh items ...
                    id: "hoc-sinh", label: "Học Sinh & Đoàn Đội", icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>`,
                    items: [ { name: "Học sinh (Khăn quàng đỏ)", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi trắng học sinh, đeo khăn quàng đỏ đội viên Việt Nam chuẩn" }, { name: "Áo Đoàn Thanh Niên", value: "Quan trọng: Chuyển thành ảnh thẻ, mặc áo sơ mi xanh Thanh Niên Việt Nam (wearing blue Vietnam Youth Union shirt ao doan thanh nien), có cờ đỏ trên túi ngực trái, nghiêm trang" } ]
                }
            };

            const els = { sidebar: document.getElementById('sidebar'), toggleSidebar: document.getElementById('toggle-sidebar-btn'), closeSidebar: document.getElementById('close-sidebar-mobile'), upload: document.getElementById('image-upload'), dropZone: document.getElementById('drop-zone'), uploadPlaceholder: document.getElementById('upload-placeholder'), fullscreenTarget: document.getElementById('fullscreen-target'), zoomIn: document.getElementById('zoom-in'), zoomOut: document.getElementById('zoom-out'), zoomReset: document.getElementById('zoom-reset'), zoomText: document.getElementById('zoom-level'), resDisplay: document.getElementById('res-display'), resText: document.getElementById('res-text'), scaleContainer: document.getElementById('canvas-scale-container'), compContainer: document.getElementById('main-comparison-container'), baseImg: document.getElementById('main-comparison-base-image'), compTop: document.getElementById('main-comparison-top'), wrapper: document.getElementById('main-canvas-wrapper'), canvas: document.getElementById('main-canvas'), slider: document.getElementById('main-comparison-slider'), placeholder: document.getElementById('placeholder-state'), terminalOverlay: document.getElementById('ai-terminal-overlay'), terminalContent: document.getElementById('terminal-content'), termPercent: document.getElementById('term-percent'), termProgBar: document.getElementById('term-progress-bar'), scanBeam: document.getElementById('scan-beam'), errorMsg: document.getElementById('error-message'), errorText: document.getElementById('error-text'), controls: document.getElementById('canvas-controls'), holdBtn: document.getElementById('btn-hold-compare'), dlTrigger: document.getElementById('download-trigger'), dlMenu: document.getElementById('download-menu'), dlResult: document.getElementById('download-result'), dlCompare: document.getElementById('download-compare'), fmtPng: document.getElementById('fmt-png'), fmtJpg: document.getElementById('fmt-jpg'), mobDlTrigger: document.getElementById('mobile-download-trigger'), mobDlMenu: document.getElementById('mobile-download-menu'), mobDlResult: document.getElementById('mobile-dl-result'), mobDlCompare: document.getElementById('mobile-dl-compare'), rotateBtn: document.getElementById('rotate-btn'), helpBtn: document.getElementById('help-btn'), helpModal: document.getElementById('help-modal'), viewSlider: document.getElementById('view-slider'), viewSplit: document.getElementById('view-split'), historyContainer: document.getElementById('history-filmstrip-container'), historyList: document.getElementById('history-list'), toggleHistoryBtn: document.getElementById('toggle-history-btn'), closeHistoryBtn: document.getElementById('close-history'), btnProcess: document.getElementById('process-image'), btnReset: document.getElementById('reset-button'), catGrid: document.getElementById('category-grid'), modal: document.getElementById('outfit-modal'), modalList: document.getElementById('modal-list-content'), modalTitle: document.getElementById('modal-title'), modalIcon: document.getElementById('modal-icon'), closeModalBtn: document.getElementById('close-modal-btn'), modalBackdrop: document.getElementById('modal-backdrop'), selectionDisplay: document.getElementById('current-selection-display'), selectedOutfitName: document.getElementById('selected-outfit-name'), reopenModalBtn: document.getElementById('reopen-modal-btn'), selectedOutfitVal: document.getElementById('selected-outfit-value'), accSel: document.getElementById('secondary-accessory-select'), selectedAccessoryDisplay: document.getElementById('accessory-selection-display'), selectedAccessoryName: document.getElementById('selected-accessory-name') };

            const ctx = els.canvas ? els.canvas.getContext('2d') : null; 
            let currentFormat = 'image/png';
            let state = { originalImg: null, base64: null, restoredObj: null, isDragging: false, zoom: 1, rotation: 0, history: [], bgPrompt: "" };
            
            // --- ID PHOTO FUNCTIONS ---
            function renderCategories() {
                if(!els.catGrid) return;
                els.catGrid.innerHTML = '';
                const order = ['cong-an', 'quan-doi', 'vest-nam', 'ao-dai', 'trang-suc', 'hoc-sinh'];
                order.forEach(id => {
                    const cat = OUTFITS[id];
                    if (cat) {
                        const btn = document.createElement('div');
                        btn.className = 'category-btn';
                        btn.innerHTML = `${cat.icon}<span>${cat.label}</span>`;
                        btn.onclick = () => openOutfitModal(cat.id);
                        els.catGrid.appendChild(btn);
                    }
                });
            }

            function openOutfitModal(catId) {
                const cat = OUTFITS[catId];
                if(!cat || !els.modal) return;
                if(els.modalTitle) els.modalTitle.textContent = cat.label;
                if(els.modalIcon) els.modalIcon.innerHTML = cat.icon;
                if(els.modalList) {
                    els.modalList.innerHTML = '';
                    cat.items.forEach(item => {
                        if (item.type === 'header') {
                            const header = document.createElement('div');
                            // CHANGE COLOR TO PURPLE HERE
                            header.className = 'text-[10px] font-bold text-purple-400 uppercase tracking-wider mt-4 mb-2 pl-2 border-b border-white/5 pb-1 flex items-center gap-2';
                            header.innerHTML = `<span class="w-1 h-1 rounded-full bg-purple-500"></span>${item.label}`;
                            els.modalList.appendChild(header);
                        } else {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'outfit-item';
                            if (catId !== 'trang-suc' && els.selectedOutfitVal && els.selectedOutfitVal.value === item.value) { itemEl.classList.add('selected'); }
                            itemEl.innerHTML = `<span class="name">${item.name}</span><div class="check"></div>`;
                            itemEl.onclick = () => selectOutfitItem(item, catId);
                            els.modalList.appendChild(itemEl);
                        }
                    });
                }
                els.modal.classList.remove('hidden');
            }

            function closeOutfitModal() { if(els.modal) els.modal.classList.add('hidden'); }

            function selectOutfitItem(item, catId) {
                if(els.reopenModalBtn) els.reopenModalBtn.onclick = () => openOutfitModal(catId);
                closeOutfitModal();
                if (catId === 'trang-suc') {
                    if(els.accSel) {
                        const options = Array.from(els.accSel.options);
                        let found = false;
                        
                        // NEW SMART MATCHING LOGIC (Match Name/Text instead of Value)
                        for(let opt of options) { 
                            if(opt.text.trim().toLowerCase() === item.name.trim().toLowerCase()) { 
                                els.accSel.value = opt.value; 
                                found = true; 
                                break; 
                            } 
                        }
                        
                        if (found) { updateAccessoryDisplay(); showToast("Đã thêm vào mục Phụ Kiện (Bước 2)", "success"); } else { showToast("Không tìm thấy phụ kiện tương ứng", "error"); }
                    }
                } else {
                    if(els.selectedOutfitVal) els.selectedOutfitVal.value = item.value;
                    if(els.selectionDisplay) els.selectionDisplay.classList.remove('hidden');
                    if(els.selectedOutfitName) els.selectedOutfitName.textContent = item.name;
                }
            }

            function updateAccessoryDisplay() {
                if (!els.accSel) return;
                const selectedOption = els.accSel.options[els.accSel.selectedIndex];
                if (selectedOption && selectedOption.value !== "") {
                    if(els.selectedAccessoryDisplay) els.selectedAccessoryDisplay.classList.remove('hidden');
                    if(els.selectedAccessoryName) els.selectedAccessoryName.textContent = selectedOption.text;
                } else {
                    if(els.selectedAccessoryDisplay) els.selectedAccessoryDisplay.classList.add('hidden');
                    if(els.selectedAccessoryName) els.selectedAccessoryName.textContent = "";
                }
            }

            // --- RESET ALL (Modified to include Visa & Video state) ---
            safeAdd(els.btnReset, 'click', () => {
                // ID PHOTO RESET
                state.originalImg = null; state.base64 = null; state.restoredObj = null; state.zoom = 1; state.rotation = 0; state.history = []; state.bgPrompt = "";
                if(els.upload) els.upload.value = '';
                if(els.placeholder) els.placeholder.classList.remove('hidden');
                if(els.compContainer) els.compContainer.classList.add('hidden');
                if(els.baseImg) els.baseImg.src = "";
                if(els.selectedOutfitVal) els.selectedOutfitVal.value = '';
                if(els.selectionDisplay) els.selectionDisplay.classList.add('hidden');
                if(els.selectedOutfitName) els.selectedOutfitName.textContent = 'Chưa chọn';
                if(els.accSel) els.accSel.value = '';
                updateAccessoryDisplay();
                const bgButtons = document.querySelectorAll('.id-bg-btn');
                bgButtons.forEach(b => b.classList.remove('ring-2', 'ring-white', 'ring-offset-1', 'ring-offset-black'));
                if(ctx && els.canvas) ctx.clearRect(0,0, els.canvas.width, els.canvas.height);
                if(els.controls) els.controls.style.display = 'none';
                if(els.resDisplay) els.resDisplay.classList.add('opacity-50');
                if(els.resText) els.resText.textContent = '-- x --';
                if(els.historyList) els.historyList.innerHTML = '<div class="text-[11px] text-slate-500 italic pl-4 font-medium">Chưa có ảnh nào...</div>';
                if(els.historyContainer) els.historyContainer.classList.add('hidden', 'translate-y-full');
                if(els.dlTrigger) { els.dlTrigger.disabled = true; els.dlTrigger.classList.add('opacity-50', 'cursor-not-allowed'); }
                if(els.mobDlTrigger) { els.mobDlTrigger.disabled = true; els.mobDlTrigger.classList.add('opacity-50', 'cursor-not-allowed'); }
                if(els.btnProcess) { els.btnProcess.disabled = false; els.btnProcess.innerHTML = `<svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>TẠO ẢNH (ENTER)`; }
                
                // VISA PHOTO RESET
                visaState.img = null; visaState.scale = 1; visaState.pos = {x:0, y:0};
                document.getElementById('visa-upload-state').classList.remove('hidden');
                document.getElementById('visa-editor-container').classList.add('hidden');
                document.getElementById('visa-tools-overlay').classList.add('hidden');
                document.getElementById('visa-editor-img').src = "";
                document.getElementById('visa-upload-input').value = "";
                
                if(window.innerWidth < 1024 && els.sidebar) els.sidebar.classList.add('-translate-x-full');
                showToast("Đã làm mới tất cả!", "success");
            });

            safeAdd(els.closeModalBtn, 'click', closeOutfitModal);
            safeAdd(els.modalBackdrop, 'click', closeOutfitModal);
            if(els.accSel) { els.accSel.addEventListener('change', updateAccessoryDisplay); }
            
            const initComparisonSlider = () => { let isResizing = false; const startResize = (e) => { isResizing = true; if(els.compContainer) els.compContainer.style.cursor = 'col-resize'; }; const stopResize = () => { isResizing = false; if(els.compContainer) els.compContainer.style.cursor = 'default'; }; const resize = (e) => { if (!isResizing || !els.compContainer) return; const rect = els.compContainer.getBoundingClientRect(); const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0); const x = clientX - rect.left; let percent = (x / rect.width) * 100; percent = Math.max(0, Math.min(100, percent)); if(els.compTop) els.compTop.style.width = `${percent}%`; if(els.slider) els.slider.style.left = `${percent}%`; }; if(els.slider) { els.slider.addEventListener('mousedown', startResize); els.slider.addEventListener('touchstart', startResize, {passive: true}); window.addEventListener('mousemove', resize); window.addEventListener('touchmove', resize, {passive: true}); window.addEventListener('mouseup', stopResize); window.addEventListener('touchend', stopResize); } }; 
            initComparisonSlider(); renderCategories();

            safeAdd(els.toggleSidebar, 'click', () => els.sidebar.classList.remove('-translate-x-full')); 
            safeAdd(els.closeSidebar, 'click', () => els.sidebar.classList.add('-translate-x-full')); 
            safeAdd(els.helpBtn, 'click', () => els.helpModal.classList.remove('hidden'));
            
            // --- FIX: HISTORY TOGGLE LOGIC ---
            safeAdd(els.toggleHistoryBtn, 'click', () => {
                if(!els.historyContainer) return;
                const isHidden = els.historyContainer.classList.contains('translate-y-full') || els.historyContainer.classList.contains('hidden');
                toggleHistory(isHidden);
            });
            safeAdd(els.closeHistoryBtn, 'click', () => toggleHistory(false));
            // ---------------------------------

            const updateTransform = () => { if(els.scaleContainer) els.scaleContainer.style.transform = `scale(${state.zoom}) rotate(${state.rotation}deg)`; if(els.zoomText) els.zoomText.textContent = Math.round(state.zoom * 100) + '%'; }; safeAdd(els.zoomIn, 'click', () => { if(state.zoom < 3) { state.zoom += 0.1; updateTransform(); }}); safeAdd(els.zoomOut, 'click', () => { if(state.zoom > 0.2) { state.zoom -= 0.1; updateTransform(); }}); safeAdd(els.zoomReset, 'click', () => { state.zoom = 1; state.rotation = 0; updateTransform(); }); safeAdd(els.rotateBtn, 'click', () => { state.rotation = (state.rotation + 90) % 360; updateTransform(); });
            
            // --- RESTORED RENDER FUNCTION AND HELPERS ---
            const render = () => {
                if (!ctx) return;
                const result = state.restoredObj; 
                const original = state.originalImg; 
                
                const target = result || original;
                if (!target) return;

                if (els.canvas.width !== target.width || els.canvas.height !== target.height) {
                    els.canvas.width = target.width;
                    els.canvas.height = target.height;
                }
                
                ctx.clearRect(0, 0, els.canvas.width, els.canvas.height);
                ctx.drawImage(target, 0, 0);
            };

            const showOrig = () => { if(els.compTop) els.compTop.style.opacity = '0'; }; 
            const showProc = () => { if(els.compTop) els.compTop.style.opacity = '1'; }; 
            
            safeAdd(els.holdBtn, 'mousedown', showOrig); 
            safeAdd(els.holdBtn, 'mouseup', showProc); 
            safeAdd(els.holdBtn, 'mouseleave', showProc); 
            safeAdd(els.holdBtn, 'touchstart', (e)=>{e.preventDefault(); showOrig()}); 
            safeAdd(els.holdBtn, 'touchend', (e)=>{e.preventDefault(); showProc()});
            
            document.addEventListener('keydown', (e) => { 
                if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return; 
                if(e.code === 'Space') { e.preventDefault(); showOrig(); } 
                if(e.key.toLowerCase() === 'r') { state.rotation = (state.rotation+90)%360; updateTransform(); } 
                if(e.key.toLowerCase() === 'f') document.documentElement.requestFullscreen(); 
                if(e.key === '0' && els.zoomReset) els.zoomReset.click(); 
                if(e.key === 'Enter' && els.btnProcess && !els.btnProcess.disabled) els.btnProcess.click(); 
            }); 
            document.addEventListener('keyup', (e) => { if(e.code === 'Space') showProc(); });

            const loadImg = (file) => {
                if (!file || !['image/png','image/jpeg','image/webp'].includes(file.type)) return showToast("Chỉ hỗ trợ ảnh PNG, JPG, WEBP", "error");
                if(els.dropZone) els.dropZone.classList.add('border-indigo-500', 'bg-indigo-500/10');
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        state.originalImg = img; state.base64 = e.target.result; state.restoredObj = null; state.history = []; 
                        try {
                            if(els.historyList) els.historyList.innerHTML = '<div class="text-[11px] text-slate-500 italic pl-4 font-medium">Chưa có ảnh nào...</div>'; 
                            if(els.baseImg) els.baseImg.src = state.base64; 
                            if(els.compContainer) { els.compContainer.classList.remove('hidden'); els.compContainer.style.display = 'block'; }
                            if(els.placeholder) { els.placeholder.classList.add('hidden'); els.placeholder.style.display = 'none'; }
                            requestAnimationFrame(() => {
                                if(els.canvas && ctx) { els.canvas.width = img.width; els.canvas.height = img.height; ctx.drawImage(img, 0, 0); }
                                if(els.wrapper && els.compContainer) { if(els.compContainer.clientWidth > 0) { els.wrapper.style.width = els.compContainer.clientWidth + 'px'; } else { els.wrapper.style.width = '100%'; } }
                                if(els.compTop) els.compTop.style.width = '0%'; if(els.slider) els.slider.style.display = 'none'; if(els.controls) els.controls.style.display = 'none'; 
                                state.zoom = 1; state.rotation = 0; updateTransform(); if(els.errorMsg) els.errorMsg.classList.add('hidden'); showToast("Đã tải ảnh thành công", "success");
                            });
                        } catch (err) { showToast("Lỗi hiển thị ảnh: " + err.message, "error"); }
                    };
                    img.onerror = () => showToast("Lỗi đọc file ảnh", "error");
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };
            safeAdd(els.upload, 'change', (e) => loadImg(e.target.files[0]));
            
            // --- AI IMAGE GENERATION (ID Photo Mode) ---
            safeAdd(els.btnProcess, 'click', async () => {
                try {
                    const apiKey = "";
                    if(!state.base64) return showToast("Vui lòng tải ảnh trước khi xử lý!", "error");
                    if(window.innerWidth < 1024) els.sidebar.classList.add('-translate-x-full');
                    els.btnProcess.disabled = true; els.btnProcess.innerHTML = `<div class="flex items-center gap-3"><div class="modern-loader"></div><span class="text-white animate-pulse tracking-widest font-bold">PROCESSING...</span></div>`;
                    if(els.scanBeam) els.scanBeam.classList.add('active');
                    if(els.terminalOverlay) els.terminalOverlay.classList.remove('hidden');

                    let prompt = ""; let negative = "";
                    const idClothes = els.selectedOutfitVal ? els.selectedOutfitVal.value : "";
                    const idAccessory = els.accSel && els.accSel.value !== "" ? els.accSel.value : ""; 
                    const cleanAccessory = idAccessory.replace(/^,\s*/, '');
                    let isAoDai = idClothes.toLowerCase().includes("ao dai") || idClothes.toLowerCase().includes("áo dài");
                    let isKeepClothes = idClothes.includes("Giữ nguyên quần áo");
                    
                    if (!idClothes || isKeepClothes) {
                         // LOGIC MỚI: GIỮ ÁO NHƯNG VẪN GHÉP ĐƯỢC TRANG SỨC
                         prompt += `(keep original clothes design:4.0), (same outfit:4.0)`;
                         if (cleanAccessory) { 
                             prompt += `, (adding jewelry ON TOP of current outfit:4.0), (wearing ${cleanAccessory}:4.0)`; 
                             prompt += `, (jewelry integrated with original clothes:3.0), (necklace laying on original fabric:3.0)`;
                         } else {
                             prompt += `, (do not change outfit:4.0)`;
                         }
                         prompt += `, (seamless blending:4.0), (natural skin transition:3.0), (preserve neck anatomy:3.0)`;
                    } else if (idClothes) {
                        prompt += `(change outfit:4.0), (completely replace clothes:4.0), ${idClothes}`;
                        // --- NEW: STRONGER REPLACEMENT COMMANDS FOR EXISTING UNIFORMS/HATS ---
                        prompt += `, (replace existing uniform:4.0), (replace existing hat:4.0), (overwrite original clothes:4.0)`;
                        
                        // LOGIC XỬ LÝ TRANG SỨC RIÊNG BIỆT (FIXED)
                        if (cleanAccessory) { 
                            prompt += `, (wearing ${cleanAccessory}:3.0)`; 
                            if (isAoDai) { prompt += `, (jewelry worn over high collar:3.0), (closed neck:3.0)`; } 
                        } else {
                            // NẾU KHÔNG CHỌN TRANG SỨC => CẤM TUYỆT ĐỐI TRANG SỨC (CLEAN CLOTHES)
                            prompt += `, (no jewelry:5.0), (no necklace:5.0), (no earrings:5.0), (unadorned:4.0), (plain clothes:3.0)`;
                            negative += `, (jewelry:5.0), (necklace:5.0), (earrings:5.0), (pendant:5.0), (chain:5.0), (pearls:5.0), (gold:4.0)`;
                        }

                        let bgString = state.bgPrompt ? state.bgPrompt : "solid pure white background, hex color #FFFFFF, clean bright white wall, simple backdrop";
                        prompt += `, ${bgString}`;
                        prompt += `, (completely replace background:3.0), (remove original background:3.0), (clean solid background:2.5), (no shadows on wall:2.0)`;
                        if (isAoDai) { prompt += `, (traditional vietnamese dress:3.0), (high collar:4.0), (long sleeves:2.0)`; negative += `, (open neck:3.0), (low cut:3.0), (cleavage:3.0), (bare chest:3.0)`; } 
                        else { prompt += `, (wear selected clothes:3.0)`; }
                    } else {
                        prompt += "professional ID photo, wearing formal white shirt";
                        prompt += ", (replace background:3.0), (remove original background:3.0)";
                        prompt += ", (maintain original head:3.0), (keep original face:3.0)";
                        // Mặc định không trang sức nếu không chọn gì
                        prompt += ", (no jewelry:5.0)";
                        negative += ", (jewelry:5.0)";
                    }
                    
                    // --- UPDATED PROMPT: STRICTLY PRESERVE FACE & HAIR ---
                    prompt += ", (COMPLETELY PRESERVE ORIGINAL FACE FROM CHIN TO HAIR:5.0), (do not change face:5.0), (do not change hair:5.0), (keep original skin texture:4.0), (no retouching:5.0), (exact original facial features:5.0), (raw photo texture:4.0)";
                    prompt += ", (strict pose retention:4.0), (match original head tilt:4.0), (match original shoulder alignment:4.0), (outfit follows body shape and angle:4.0), (maintain original framing:3.0)";
                    
                    // FIX: ANTI-FLIP / CORRECT ORIENTATION FOR JEWELRY
                    prompt += ", (correct orientation:4.0), (not mirrored:4.0), (jewelry facing forward:3.0), (symmetrical design:2.0), (text correct way:3.0)";
                    
                    // NEW: FIX SIZE & REALISM (ANTI-OVERSIZED)
                    prompt += ", (realistic SMALL size jewelry:5.0), (proportionate to face:4.0), (delicate fine chain:4.0), (not oversized:5.0)";
                    prompt += ", (tiny details:3.0), (correct scale vs face:4.0)";
                    
                    // FIX: ANTI-OVERSIZED BADGES & STARS (FOR POLICE)
                    if (idClothes.includes("Công An") || idClothes.includes("Vietnam Police")) {
                        prompt += ", (small collar badge:4.0), (tiny metal stars:4.0), (thin stripes on epaulettes:4.0)";
                        prompt += ", (proportionate insignia:4.0), (not cartoonish badge:4.0), (standard size emblem:4.0)";
                        negative += ", (giant star:5.0), (huge badge:5.0), (oversized epaulettes:5.0), (thick stripes:4.0)";
                    }

                    // NEW: AUTO-FIT NECK & SHIRT INTELLIGENCE & LOW PLACEMENT (VERY STRONG PHYSICS)
                    prompt += ", (jewelry adapts to neck size:4.0), (perfect fit for body type:3.0), (jewelry physically interacts with clothing:4.0)";
                    prompt += ", (chain TUCKED UNDER COLLAR flaps:5.0), (pendant resting ON FABRIC:4.0), (heavy gravity pulling chain down:4.0)";
                    prompt += ", (following natural neck curve:4.0), (resting on clavicle:4.0), (not too tight:4.0), (lower placement on neck:3.0), (resting on chest:3.0)";
                    // FIX: NEW COMMANDS FOR SYMMETRY & LEFT SIDE
                    prompt += ", (resting on trapezius muscles:4.0), (hugging base of neck tightly:4.0), (contouring to neck and shoulders:3.0)";
                    prompt += ", (symmetrical placement:4.0), (even drape on both sides:4.0), (left side matches right side:4.0)";
                    prompt += ", (no gap between jewelry and skin:4.0), (physically lower:3.0), (cast shadow on skin:3.0)";

                    prompt += ", high quality, masterpiece, photorealistic, 8k resolution"; 
                    
                    negative += ", (original background:3.0), (cluttered background)";
                    negative += ", (shadows:2.0), (grey background), (off-white), (textured wall), (dirty wall)";
                    // --- UPDATED NEGATIVE: FORBID BEAUTIFICATION & CHINESE ELEMENTS & FACE CHANGES ---
                    // CẤM TUYỆT ĐỐI CHỈNH SỬA MẶT
                    negative += ", (change face:5.0), (new face:5.0), (makeup:5.0), (smooth skin:5.0), (retouching:5.0), (beautify:5.0)";
                    negative += ", (new hair:5.0), (changed hair:5.0), (haircut:5.0), (face restoration:5.0), (filter), (drawing), (plastic skin)";
                    negative += ", (lipstick:4.0), (eyeshadow:4.0), (foundation:4.0), (blush:4.0)"; // Cấm trang điểm
                    
                    // FIX: NEGATIVE PROMPT FOR MIRRORING & NECK ARTIFACTS & OVERSIZED JEWELRY & HIGH PLACEMENT
                    negative += ", (mirrored image:4.0), (flipped:4.0), (inverted:4.0), (backwards:4.0), (reverse orientation:3.0)";
                    negative += ", (floating jewelry:5.0), (levitating necklace:5.0), (jewelry ON TOP of collar:5.0), (neck gap:4.0), (mismatched neck:4.0)";
                    negative += ", (oversized jewelry:5.0), (giant pearls:5.0), (huge beads:5.0), (chunky necklace:5.0), (thick chain:5.0), (heavy jewelry:4.0), (cartoonish jewelry:4.0)";
                    negative += ", (choker style:5.0), (too high on neck:5.0), (strangling:5.0), (tight fit:4.0), (floating behind neck:4.0), (jewelry covering chin:4.0)";
                    // FIX: NEGATIVE PROMPT FOR ASYMMETRY (LEFT/RIGHT ERRORS)
                    negative += ", (floating above shoulders:5.0), (high arc:4.0), (defying gravity:5.0), (hovering over skin:5.0), (stiff necklace:4.0)";
                    negative += ", (lopsided necklace:4.0), (uneven chain:4.0), (crooked jewelry:4.0), (one side higher than other:4.0)";

                    // --- STRICT ANTI-TEXT & ANTI-CHINESE FILTER (IRON HAND) ---
                    negative += ", (Chinese text:5.0), (Chinese characters:5.0), (Kanji:5.0), (Hanzi:5.0), (writing on hat:5.0), (text on badge:5.0), (letters on wreath:5.0)";
                    negative += ", (Chinese uniform:5.0), (China police:5.0), (PLA:5.0), (Chinese flag:5.0), (Chinese emblem:5.0)";
                    negative += ", (Type 07 uniform:4.0), (Chinese collar:4.0), (foreign military:4.0), (American uniform), (blue police uniform), (black police uniform)";
                    negative += ", (wrong star shape), (wrong badge), (incorrect epaulettes)";
                    
                    const payload = { contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: state.base64.split(';')[0].split(':')[1], data: state.base64.split(',')[1] } } ] }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'] } };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                    const data = await fetchWithRetry(apiUrl, payload);
                    const imgData = data.candidates?.[0]?.content?.parts?.find(p=>p.inlineData)?.inlineData?.data;
                    
                    if(!imgData) throw new Error("Không tạo được ảnh (Lỗi Safety hoặc Prompt)."); 
                    
                    const resImg = new Image();
                    resImg.onload = () => {
                        state.restoredObj = resImg; els.canvas.width = resImg.width; els.canvas.height = resImg.height; render(); addToHistory(resImg);
                        if(els.terminalOverlay) els.terminalOverlay.classList.add('hidden'); if(els.scanBeam) els.scanBeam.classList.remove('active');
                        els.btnProcess.disabled = false; els.btnProcess.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> TẠO ẢNH (ENTER)`;
                        if(els.compTop) els.compTop.style.width = '50%'; if(els.slider) els.slider.style.display = 'flex'; if(els.slider) els.slider.style.left = '50%'; if(els.controls) els.controls.style.display = 'flex';
                        if(els.dlTrigger) { els.dlTrigger.disabled = false; els.dlTrigger.classList.remove('opacity-50', 'cursor-not-allowed'); }
                        
                        // FIX: Enable mobile button explicitly here
                        if(els.mobDlTrigger) { 
                             els.mobDlTrigger.disabled = false; 
                             els.mobDlTrigger.classList.remove('opacity-50', 'cursor-not-allowed'); 
                        }

                        showToast("Xử lý ảnh hoàn tất!", "success");
                    };
                    resImg.src = `data:image/png;base64,${imgData}`;
                } catch (err) {
                    console.error("Image Processing Error:", err); 
                    if(els.terminalOverlay) els.terminalOverlay.classList.add('hidden'); if(els.scanBeam) els.scanBeam.classList.remove('active');
                    els.btnProcess.disabled = false; els.btnProcess.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> TẠO ẢNH (ENTER)`; 
                    showToast("Lỗi xử lý ảnh: " + err.message.substring(0, 50) + "...", "error");
                }
            });

            // ==========================================
            // MODULE 2: VISA PHOTO PRO (EXISTING LOGIC)
            // ==========================================
            const VISA_CONTAINER_WIDTH = 320;
            const visaConfig = {
                usa: { flag: '🇺🇸', name: 'Mỹ (USA)', widthMm: 51, heightMm: 51, ratio: 1, desc: '51x51mm. Phông trắng. Mặt chiếm 50-69%.', outputSize: 600, guideColor: 'rgba(34, 197, 94, 0.7)', headOval: { w: 0.55, h: 0.6, y: 0.5 } },
                canada: { flag: '🇨🇦', name: 'Canada', widthMm: 50, heightMm: 70, ratio: 50/70, desc: '50x70mm. Phông trắng. Mặt cao 31-36mm.', outputSize: 600, guideColor: 'rgba(239, 68, 68, 0.7)', headOval: { w: 0.6, h: 0.48, y: 0.45 } },
                vietnam: { flag: '🇻🇳', name: 'Passport VN', widthMm: 41, heightMm: 61, ratio: 41/61, desc: '4x6cm (Passport). Phông trắng. Chụp thẳng.', outputSize: 600, guideColor: 'rgba(218, 41, 28, 0.7)', headOval: { w: 0.6, h: 0.5, y: 0.45 } },
                china: { flag: '🇨🇳', name: 'Trung Quốc', widthMm: 33, heightMm: 48, ratio: 33/48, desc: '33x48mm. Phông trắng. Đầu rộng 15-22mm.', outputSize: 420, guideColor: 'rgba(220, 38, 38, 0.7)', headOval: { w: 0.55, h: 0.6, y: 0.45 } },
                japan: { flag: '🇯🇵', name: 'Nhật Bản', widthMm: 45, heightMm: 45, ratio: 1, desc: '45x45mm. Phông trắng. Không kính màu.', outputSize: 600, guideColor: 'rgba(59, 130, 246, 0.7)', headOval: { w: 0.55, h: 0.6, y: 0.5 } },
                korea: { flag: '🇰🇷', name: 'Hàn Quốc', widthMm: 35, heightMm: 45, ratio: 35/45, desc: '35x45mm. Phông trắng. Môi khép kín.', outputSize: 600, guideColor: 'rgba(79, 70, 229, 0.7)', headOval: { w: 0.6, h: 0.7, y: 0.5 } },
                singapore: { flag: '🇸🇬', name: 'Singapore', widthMm: 35, heightMm: 45, ratio: 35/45, desc: '35x45mm. Phông trắng. Bề mặt mờ.', outputSize: 600, guideColor: 'rgba(234, 179, 8, 0.7)', headOval: { w: 0.65, h: 0.7, y: 0.5 } },
                schengen: { flag: '🇪🇺', name: 'Châu Âu', widthMm: 35, heightMm: 45, ratio: 35/45, desc: '35x45mm. Chuẩn ICAO (Pháp, Đức, Ý...).', outputSize: 600, guideColor: 'rgba(14, 165, 233, 0.7)', headOval: { w: 0.6, h: 0.7, y: 0.5 } }
            };

            let visaState = { country: 'usa', img: null, scale: 1, pos: { x: 0, y: 0 }, isDragging: false, dragStart: { x: 0, y: 0 } };

            const visaEls = {
                grid: document.getElementById('visa-country-grid'),
                placeholder: document.getElementById('visa-upload-state'),
                editor: document.getElementById('visa-editor-container'),
                imgEl: document.getElementById('visa-editor-img'),
                uploadInput: document.getElementById('visa-upload-input'),
                changeBtn: document.getElementById('visa-change-img-btn'),
                tools: document.getElementById('visa-tools-overlay'),
                autoBtn: document.getElementById('visa-auto-align-btn'),
                zoomSlider: document.getElementById('visa-zoom-slider'),
                mobileZoomSlider: document.getElementById('visa-mobile-zoom-slider'), 
                dlBtn: document.getElementById('visa-download-btn'),
                infoFlag: document.getElementById('visa-flag-icon'),
                infoText: document.getElementById('visa-country-info'),
                guides: {
                    oval: document.getElementById('visa-guide-oval'),
                    eye: document.getElementById('visa-guide-eye'),
                    eyeLabel: document.getElementById('visa-guide-eye-label'),
                    chin: document.getElementById('visa-guide-chin'),
                    chinLabel: document.getElementById('visa-guide-chin-label'),
                    top: document.getElementById('visa-guide-top'),
                    topLabel: document.getElementById('visa-guide-top-label')
                },
                radar: document.getElementById('visa-radar-overlay') // NEW
            };

            function renderVisaCountries() {
                visaEls.grid.innerHTML = '';
                Object.entries(visaConfig).forEach(([key, conf]) => {
                    const btn = document.createElement('button');
                    btn.className = `visa-country-btn flex flex-col items-center justify-center p-3 rounded-xl border border-white/5 bg-white/5 hover:bg-white/10 ${visaState.country === key ? 'active' : ''}`;
                    btn.innerHTML = `<span class="text-2xl mb-1">${conf.flag}</span><span class="text-[10px] font-bold text-slate-300 uppercase">${conf.name}</span><span class="text-[9px] text-slate-500">${conf.widthMm}x${conf.heightMm}</span>`;
                    btn.onclick = () => setVisaCountry(key);
                    visaEls.grid.appendChild(btn);
                });
            }

            function setVisaCountry(key) {
                visaState.country = key;
                renderVisaCountries();
                updateVisaGuides();
                if (visaState.img) autoAlignVisa();
                const conf = visaConfig[key];
                visaEls.infoFlag.textContent = conf.flag;
                visaEls.infoText.textContent = `${conf.name} - ${conf.widthMm}x${conf.heightMm}mm`;
            }

            function updateVisaGuides() {
                const conf = visaConfig[visaState.country];
                const containerH = VISA_CONTAINER_WIDTH / conf.ratio;
                visaEls.editor.style.height = `${containerH}px`;
                visaEls.guides.oval.style.width = `${conf.headOval.w * 100}%`;
                visaEls.guides.oval.style.height = `${conf.headOval.h * 100}%`;
                visaEls.guides.oval.style.top = `${conf.headOval.y * 100}%`;
                visaEls.guides.oval.style.borderColor = conf.guideColor;
                visaEls.guides.oval.style.boxShadow = `0 0 10px ${conf.guideColor}`; // Added Glow

                // Eyes
                const eyeY = (conf.headOval.y * 100) - 5;
                visaEls.guides.eye.style.top = `${eyeY}%`;
                visaEls.guides.eye.style.borderColor = conf.guideColor;
                visaEls.guides.eye.style.boxShadow = `0 0 8px ${conf.guideColor}`; // Added Glow
                visaEls.guides.eyeLabel.style.top = `${eyeY - 7}%`;
                
                // Chin
                const chinY = (conf.headOval.y * 100) + (conf.headOval.h * 50);
                visaEls.guides.chin.style.top = `${chinY}%`;
                visaEls.guides.chin.style.borderColor = conf.guideColor;
                visaEls.guides.chin.style.boxShadow = `0 0 8px ${conf.guideColor}`; // Added Glow
                if(visaEls.guides.chinLabel) visaEls.guides.chinLabel.style.top = `${chinY - 7}%`;

                // Top Head
                const topY = (conf.headOval.y * 100) - (conf.headOval.h * 50);
                if(visaEls.guides.top) {
                    visaEls.guides.top.style.top = `${topY}%`;
                    visaEls.guides.top.style.borderColor = conf.guideColor;
                    visaEls.guides.top.style.boxShadow = `0 0 8px ${conf.guideColor}`; // Added Glow
                }
                if(visaEls.guides.topLabel) visaEls.guides.topLabel.style.top = `${topY - 7}%`;
            }

            function handleVisaUpload(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        visaState.img = img;
                        visaEls.placeholder.classList.add('hidden');
                        visaEls.editor.classList.remove('hidden');
                        visaEls.tools.classList.remove('hidden');
                        visaEls.imgEl.src = img.src;
                        
                        // SHOW RADAR SCAN EFFECT
                        if(visaEls.radar) {
                            visaEls.radar.style.display = 'block';
                            setTimeout(() => {
                                visaEls.radar.style.display = 'none';
                                showToast("Đã quét và căn chỉnh khuôn mặt!", "success");
                            }, 1500);
                        }

                        autoAlignVisa();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            function autoAlignVisa() {
                if (!visaState.img) return;
                const conf = visaConfig[visaState.country];
                const imgW = visaState.img.width;
                const imgH = visaState.img.height;
                const containerH = VISA_CONTAINER_WIDTH / conf.ratio;
                const scaleX = VISA_CONTAINER_WIDTH / imgW;
                const scaleY = containerH / imgH;
                let optimalScale = Math.max(scaleX, scaleY);
                let x = 0; let y = 0;
                if (imgH / imgW > 1.2) { optimalScale = optimalScale * 1.35; y = (imgH * optimalScale) * 0.15; } else { optimalScale = optimalScale * 1.1; }
                visaState.scale = optimalScale;
                visaState.pos = { x, y };
                updateVisaEditor();
                // Update BOTH sliders
                const minVal = optimalScale * 0.5;
                const maxVal = optimalScale * 3;
                if(visaEls.zoomSlider) {
                    visaEls.zoomSlider.min = minVal;
                    visaEls.zoomSlider.max = maxVal;
                    visaEls.zoomSlider.value = optimalScale;
                }
                if(visaEls.mobileZoomSlider) {
                    visaEls.mobileZoomSlider.min = minVal;
                    visaEls.mobileZoomSlider.max = maxVal;
                    visaEls.mobileZoomSlider.value = optimalScale;
                }
            }

            function updateVisaEditor() {
                if (!visaEls.imgEl) return;
                visaEls.imgEl.style.transform = `translate(-50%, -50%) translate(${visaState.pos.x}px, ${visaState.pos.y}px) scale(${visaState.scale})`;
            }

            if (visaEls.editor) {
                const startDrag = (cx, cy) => { visaState.isDragging = true; visaState.dragStart = { x: cx - visaState.pos.x, y: cy - visaState.pos.y }; visaEls.editor.style.cursor = 'grabbing'; };
                const moveDrag = (cx, cy) => { if (!visaState.isDragging) return; visaState.pos = { x: cx - visaState.dragStart.x, y: cy - visaState.dragStart.y }; updateVisaEditor(); };
                const endDrag = () => { visaState.isDragging = false; visaEls.editor.style.cursor = 'move'; };
                visaEls.editor.addEventListener('mousedown', (e) => startDrag(e.clientX, e.clientY));
                window.addEventListener('mousemove', (e) => moveDrag(e.clientX, e.clientY));
                window.addEventListener('mouseup', endDrag);
                visaEls.editor.addEventListener('touchstart', (e) => startDrag(e.touches[0].clientX, e.touches[0].clientY));
                window.addEventListener('touchmove', (e) => moveDrag(e.touches[0].clientX, e.touches[0].clientY));
                window.addEventListener('touchend', endDrag);
            }

            // Sync Sliders Logic
            if (visaEls.zoomSlider) { 
                visaEls.zoomSlider.addEventListener('input', (e) => { 
                    visaState.scale = parseFloat(e.target.value); 
                    if(visaEls.mobileZoomSlider) visaEls.mobileZoomSlider.value = visaState.scale; // Sync mobile
                    updateVisaEditor(); 
                }); 
            }
            if (visaEls.mobileZoomSlider) {
                visaEls.mobileZoomSlider.addEventListener('input', (e) => {
                    visaState.scale = parseFloat(e.target.value);
                    if(visaEls.zoomSlider) visaEls.zoomSlider.value = visaState.scale; // Sync sidebar
                    updateVisaEditor();
                });
            }

            function downloadVisa() {
                if (!visaState.img) return showToast("Chưa có ảnh!", "error");
                const conf = visaConfig[visaState.country];
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const outputW = conf.outputSize; const outputH = outputW / conf.ratio;
                canvas.width = outputW; canvas.height = outputH;
                ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                const containerW = VISA_CONTAINER_WIDTH; const renderRatio = outputW / containerW;
                const drawW = visaState.img.width * visaState.scale * renderRatio;
                const drawH = visaState.img.height * visaState.scale * renderRatio;
                const drawX = (visaState.pos.x * renderRatio) + (outputW - drawW) / 2;
                const drawY = (visaState.pos.y * renderRatio) + (outputH - drawH) / 2;
                ctx.drawImage(visaState.img, drawX, drawY, drawW, drawH);
                
                // MOBILE DETECT FOR VISA
                if(window.innerWidth < 1024) {
                    showMobileSaveModal(canvas.toDataURL('image/jpeg', 0.95), 'image');
                } else {
                    const link = document.createElement('a');
                    link.download = `Visa_${conf.name}_${Date.now()}.jpg`; link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click(); 
                    showToast("Đang tải ảnh Visa...", "success");
                }
            }

            if(visaEls.placeholder) visaEls.placeholder.addEventListener('click', () => visaEls.uploadInput.click());
            if(visaEls.changeBtn) visaEls.changeBtn.addEventListener('click', () => visaEls.uploadInput.click());
            if(visaEls.uploadInput) visaEls.uploadInput.addEventListener('change', (e) => handleVisaUpload(e.target.files[0]));
            if(visaEls.autoBtn) visaEls.autoBtn.addEventListener('click', () => { autoAlignVisa(); showToast("Đã tự động căn chỉnh!", "success"); });
            if(visaEls.dlBtn) visaEls.dlBtn.addEventListener('click', downloadVisa);
            
            // ==========================================
            // MODULE 3: VIDEO COMPARE PRO (NEW LOGIC)
            // ==========================================
            const vidState = {
                orgImg: null, editImg: null, logoImg: null,
                duration: 3.0, pauseDuration: 1.0, animType: 'scan', scanDir: 'horizontal',
                isPlaying: false, isRecording: false, startTime: null, reqId: null,
                aspectRatio: 'original', scaleMode: 'contain',
                logoMode: 'text', logoPos: 'bottom-right', logoSize: 15,
                wmText: 'CHƯA THANH TOÁN', wmDensity: 3, wmStyle: 'remini', wmOpacity: 80,
                cacheCanvas: null, mediaRecorder: null, chunks: []
            };

            const vidEls = {
                canvas: document.getElementById('video-compare-canvas'),
                placeholder: document.getElementById('vid-canvas-placeholder'),
                upOrg: document.getElementById('vid-up-org'), prevOrg: document.getElementById('vid-prev-org'), phOrg: document.getElementById('vid-placeholder-org'),
                upEdit: document.getElementById('vid-up-edit'), prevEdit: document.getElementById('vid-prev-edit'), phEdit: document.getElementById('vid-placeholder-edit'),
                upLogo: document.getElementById('vid-up-logo'),
                playBtn: document.getElementById('vid-play-btn'), playText: document.getElementById('vid-play-text'),
                exportBtn: document.getElementById('vid-export-btn'), exportText: document.getElementById('vid-export-text'), exportProg: document.getElementById('vid-export-prog'),
                resetBtn: document.getElementById('vid-reset-btn'),
                wmTextInput: document.getElementById('wm-text-input'), wmOpacityInput: document.getElementById('wm-opacity'), wmOpacityVal: document.getElementById('wm-opacity-val'),
                animDur: document.getElementById('anim-dur'), animDurVal: document.getElementById('anim-dur-val'),
                animPause: document.getElementById('anim-pause'), animPauseVal: document.getElementById('anim-pause-val'),
                wmLogoPos: document.getElementById('wm-logo-pos'), wmLogoSize: document.getElementById('wm-logo-size')
            };

            const createOptimizedImage = (src) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const MAX_SIZE = 1920;
                        if (img.width <= MAX_SIZE && img.height <= MAX_SIZE) { resolve(img); return; }
                        const canvas = document.createElement('canvas');
                        let width = img.width, height = img.height;
                        if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
                        else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        const optimizedImg = new Image(); optimizedImg.onload = () => resolve(optimizedImg); optimizedImg.src = canvas.toDataURL('image/jpeg', 0.90);
                    };
                    img.src = src;
                });
            };

            const handleVidUpload = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    const src = evt.target.result;
                    const img = await createOptimizedImage(src);
                    if (type === 'org') {
                        vidState.orgImg = img;
                        vidEls.prevOrg.src = src; vidEls.prevOrg.classList.remove('hidden'); vidEls.phOrg.classList.add('hidden');
                    } else if (type === 'edit') {
                        vidState.editImg = img;
                        vidEls.prevEdit.src = src; vidEls.prevEdit.classList.remove('hidden'); vidEls.phEdit.classList.add('hidden');
                    } else if (type === 'logo') {
                        vidState.logoImg = img; vidState.logoMode = 'image';
                        updateLogoUI();
                    }
                    checkVidReady();
                    drawVideoFrame(0);
                };
                reader.readAsDataURL(file);
            };

            const checkVidReady = () => {
                const ready = vidState.orgImg && vidState.editImg;
                if (ready) {
                    vidEls.canvas.classList.remove('hidden'); vidEls.placeholder.classList.add('hidden');
                    vidEls.playBtn.disabled = false; vidEls.playBtn.classList.remove('bg-slate-700', 'text-slate-500', 'cursor-not-allowed'); vidEls.playBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-500');
                    vidEls.exportBtn.disabled = false; vidEls.exportBtn.classList.remove('bg-slate-700', 'text-slate-500', 'cursor-not-allowed'); vidEls.exportBtn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-500');
                }
            };

            const updateWatermarkCache = (width, height, renderW, renderH, renderX, renderY) => {
                const cacheCanvas = document.createElement('canvas'); cacheCanvas.width = width; cacheCanvas.height = height;
                const ctx = cacheCanvas.getContext('2d');
                const baseSize = Math.min(renderW, renderH);

                if (vidState.logoMode === 'image' && vidState.logoImg) {
                    const imgLogo = vidState.logoImg;
                    const logoW = renderW * (vidState.logoSize / 100);
                    const logoH = (imgLogo.height / imgLogo.width) * logoW;
                    const padding = baseSize * 0.05;
                    const bottomSafe = (vidState.aspectRatio === '9:16' || vidState.aspectRatio === 'auto') ? Math.min(renderH * 0.15, 300) : padding;
                    let lx, ly;
                    if (vidState.logoPos.includes('right')) lx = renderX + renderW - logoW - padding; else lx = renderX + padding;
                    if (vidState.logoPos.includes('bottom')) ly = renderY + renderH - logoH - bottomSafe; else ly = renderY + padding;
                    lx = Math.max(renderX, Math.min(lx, renderX + renderW - logoW));
                    ly = Math.max(renderY, Math.min(ly, renderY + renderH - logoH));
                    ctx.globalAlpha = vidState.wmOpacity / 100;
                    ctx.drawImage(imgLogo, lx, ly, logoW, logoH);
                } else if (vidState.logoMode === 'text' && vidState.wmText) {
                    const fontSize = Math.round(renderW * 0.035); // 3.5%
                    const centerX = renderX + renderW / 2; const centerY = renderY + renderH / 2;
                    ctx.translate(centerX, centerY); ctx.rotate(-Math.PI / 4);
                    const baseOpacity = vidState.wmOpacity / 100;
                    
                    let part1 = vidState.wmText, part2 = "";
                    if (vidState.wmText.trim().toUpperCase() === 'CHƯA THANH TOÁN') { part1 = "Chưa"; part2 = "thanh toán"; } 
                    else if (vidState.wmStyle === 'remini' && vidState.wmText.includes(' ')) {
                        const words = vidState.wmText.split(' '); const mid = Math.ceil(words.length / 2);
                        part1 = words.slice(0, mid).join(' '); part2 = words.slice(mid).join(' ');
                    }

                    const densityFactor = 5 / vidState.wmDensity;
                    const blockHeight = fontSize * 3;
                    const spacingX = fontSize * 10 * (densityFactor * 0.8);
                    const spacingY = blockHeight * 2.5 * (densityFactor * 0.6);
                    const renderDiag = Math.sqrt(width * width + height * height);
                    const numLinesY = Math.ceil(renderDiag / spacingY) + 4;
                    const numColsX = Math.ceil(renderDiag / spacingX) + 4;

                    for (let i = -Math.floor(numColsX/2); i <= Math.floor(numColsX/2); i++) {
                        for (let j = -Math.floor(numLinesY/2); j <= Math.floor(numLinesY/2); j++) {
                            let staggerOffset = (vidState.wmStyle === 'remini' && Math.abs(j) % 2 === 1) ? spacingX * 0.5 : 0;
                            const x = (i * spacingX) + staggerOffset; const y = j * spacingY;
                            
                            if (vidState.wmStyle === 'remini') {
                                if (part2) {
                                    const font1Size = fontSize * 1.8; const font2Size = fontSize * 0.9;
                                    const topY = y - (font1Size * 0.1); const botY = y + (font2Size * 1.2);
                                    ctx.font = `900 ${font1Size}px "Arial Black", sans-serif`; ctx.globalAlpha = baseOpacity * 0.35; ctx.textAlign = 'center'; ctx.fillStyle = '#ffffff'; ctx.fillText(part1, x, topY);
                                    ctx.font = `600 ${font2Size}px sans-serif`; ctx.globalAlpha = baseOpacity * 0.95; ctx.fillText(part2, x, botY);
                                    const maxW = Math.max(ctx.measureText(part1).width, ctx.measureText(part2).width);
                                    const lineGap = maxW / 2 + (spacingX * 0.15);
                                    ctx.beginPath(); ctx.moveTo(x + lineGap, y); ctx.lineTo(x + spacingX - lineGap, y); ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; ctx.lineWidth = fontSize * 0.08; ctx.stroke();
                                    ctx.beginPath(); ctx.moveTo(x - spacingX + lineGap, y); ctx.lineTo(x - lineGap, y); ctx.stroke();
                                } else {
                                    ctx.font = `900 ${fontSize}px sans-serif`; ctx.globalAlpha = baseOpacity; ctx.fillStyle = '#ffffff'; ctx.fillText(vidState.wmText, x, y);
                                }
                            } else if (vidState.wmStyle === 'mixed') {
                                ctx.font = `900 ${fontSize}px sans-serif`;
                                const isHighlight = (Math.abs(i) + Math.abs(j)) % 2 === 0;
                                ctx.textAlign = 'center';
                                if (isHighlight) { ctx.globalAlpha = baseOpacity; ctx.strokeStyle = '#000000'; ctx.lineWidth = fontSize * 0.12; ctx.lineJoin = 'round'; ctx.strokeText(vidState.wmText, x, y); ctx.fillStyle = '#ffffff'; ctx.fillText(vidState.wmText, x, y); } 
                                else { ctx.globalAlpha = baseOpacity * 0.35; ctx.strokeStyle = '#000000'; ctx.lineWidth = fontSize * 0.08; ctx.lineJoin = 'round'; ctx.strokeText(vidState.wmText, x, y); ctx.fillStyle = '#ffffff'; ctx.fillText(vidState.wmText, x, y); }
                            } else {
                                ctx.font = `900 ${fontSize}px sans-serif`; ctx.textAlign = 'center'; ctx.globalAlpha = baseOpacity; ctx.strokeStyle = '#000000'; ctx.lineWidth = fontSize * 0.1; ctx.strokeText(vidState.wmText, x, y); ctx.fillStyle = '#ffffff'; ctx.fillText(vidState.wmText, x, y);
                            }
                        }
                    }
                }
                return cacheCanvas;
            };

            const drawVideoFrame = (progress) => {
                const canvas = vidEls.canvas; const ctx = canvas.getContext('2d');
                const imgOrg = vidState.orgImg; const imgEdit = vidState.editImg;
                if (!canvas || !imgOrg || !imgEdit) return;

                // 1. Calc Canvas Size
                let canvasW, canvasH;
                if (vidState.aspectRatio === 'original') {
                    const MAX_DIM = 1280;
                    let w = imgOrg.width, h = imgOrg.height;
                    if (w > MAX_DIM || h > MAX_DIM) { const ratio = w/h; if(w>h) { w=MAX_DIM; h=w/ratio; } else { h=MAX_DIM; w=h*ratio; } }
                    canvasW = Math.round(w/2)*2; canvasH = Math.round(h/2)*2;
                } else if (vidState.aspectRatio === '9:16') { canvasW = 720; canvasH = 1280; } else { canvasW = 1280; canvasH = 720; }
                
                if (canvas.width !== canvasW || canvas.height !== canvasH) { canvas.width = canvasW; canvas.height = canvasH; vidState.cacheCanvas = null; }

                // 2. Calc Layout
                let renderW, renderH, renderX, renderY;
                const imgRatio = imgOrg.width / imgOrg.height; const canvasRatio = canvasW / canvasH;
                if (vidState.scaleMode === 'cover') {
                    if (imgRatio > canvasRatio) { renderH = canvasH; renderW = renderH * imgRatio; renderY = 0; renderX = (canvasW - renderW) / 2; }
                    else { renderW = canvasW; renderH = renderW / imgRatio; renderX = 0; renderY = (canvasH - renderH) / 2; }
                } else {
                    if (imgRatio > canvasRatio) { renderW = canvasW; renderH = renderW / imgRatio; renderX = 0; renderY = (canvasH - renderH) / 2; }
                    else { renderH = canvasH; renderW = renderH * imgRatio; renderY = 0; renderX = (canvasW - renderW) / 2; }
                }
                renderW = Math.ceil(renderW); renderH = Math.ceil(renderH); renderX = Math.round(renderX); renderY = Math.round(renderY);

                // 3. Draw
                ctx.fillStyle = '#000000'; ctx.fillRect(0, 0, canvasW, canvasH);
                ctx.save(); ctx.beginPath(); ctx.rect(renderX, renderY, renderW, renderH); ctx.clip();
                ctx.drawImage(imgOrg, renderX, renderY, renderW, renderH);

                // Animation
                let scanLineX = 0, scanLineY = 0;
                if (vidState.animType === 'scan') {
                    const scanColor = '#FFD700';
                    if (vidState.scanDir === 'horizontal') {
                        const scanPos = progress * renderW; const absX = renderX + scanPos;
                        scanLineX = absX; scanLineY = renderY + renderH / 2;
                        ctx.save(); ctx.beginPath(); ctx.rect(renderX, renderY, scanPos, renderH); ctx.clip();
                        ctx.drawImage(imgEdit, renderX, renderY, renderW, renderH); ctx.restore();
                        ctx.beginPath(); ctx.moveTo(absX, renderY); ctx.lineTo(absX, renderY + renderH);
                        ctx.lineWidth = Math.max(3, renderW * 0.005); ctx.strokeStyle = scanColor; ctx.stroke();
                    } else {
                        const scanPos = progress * renderH; const absY = renderY + scanPos;
                        scanLineX = renderX + renderW / 2; scanLineY = absY;
                        ctx.save(); ctx.beginPath(); ctx.rect(renderX, renderY, renderW, scanPos); ctx.clip();
                        ctx.drawImage(imgEdit, renderX, renderY, renderW, renderH); ctx.restore();
                        ctx.beginPath(); ctx.moveTo(renderX, absY); ctx.lineTo(renderX + renderW, absY);
                        ctx.lineWidth = Math.max(3, renderW * 0.005); ctx.strokeStyle = scanColor; ctx.stroke();
                    }
                } else if (vidState.animType === 'fade') {
                    ctx.save(); ctx.globalAlpha = progress; ctx.drawImage(imgEdit, renderX, renderY, renderW, renderH); ctx.restore();
                }
                ctx.restore();

                // Scan Handle
                if (vidState.animType === 'scan') {
                    const handleSize = Math.min(renderW, renderH) * 0.045;
                    const drawHandle = (vidState.scanDir === 'horizontal') ? (scanLineX >= renderX && scanLineX <= renderX+renderW) : (scanLineY >= renderY && scanLineY <= renderY+renderH);
                    if (drawHandle) {
                        ctx.beginPath(); ctx.arc(scanLineX, scanLineY, handleSize, 0, 2 * Math.PI); ctx.fillStyle = 'rgba(255, 215, 0, 0.3)'; ctx.fill();
                        ctx.beginPath(); ctx.arc(scanLineX, scanLineY, handleSize * 0.7, 0, 2 * Math.PI); ctx.fillStyle = '#ffffff'; ctx.fill();
                        ctx.lineWidth = 2; ctx.strokeStyle = '#FFD700'; ctx.stroke();
                        ctx.fillStyle = '#000'; ctx.font = `bold ${handleSize * 0.5}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                        ctx.fillText(vidState.scanDir === 'horizontal' ? "◀ ▶" : "▲ ▼", scanLineX, scanLineY + 1);
                    }
                }

                // Watermark
                ctx.save(); ctx.beginPath(); ctx.rect(renderX, renderY, renderW, renderH); ctx.clip();
                if (!vidState.cacheCanvas) vidState.cacheCanvas = updateWatermarkCache(canvasW, canvasH, renderW, renderH, renderX, renderY);
                if (vidState.cacheCanvas) ctx.drawImage(vidState.cacheCanvas, 0, 0);
                ctx.restore();
            };

            const animateVideo = (timestamp) => {
                if (!vidState.startTime) vidState.startTime = timestamp;
                const elapsed = (timestamp - vidState.startTime) / 1000;
                const totalCycle = (vidState.duration * 2) + (vidState.pauseDuration * 2);

                if (vidState.isRecording) {
                    // Update Progress Bar
                    const pct = Math.min(100, Math.round((elapsed / totalCycle) * 100));
                    vidEls.exportProg.style.width = `${pct}%`;
                    if (elapsed >= totalCycle) { stopRecording(); return; }
                } else if (elapsed >= totalCycle) { vidState.startTime = timestamp; }

                const t = elapsed % totalCycle;
                let progress = 0;
                const ease = (x) => x < 0.5 ? 4 * x * x * x : 1 - Math.pow(-2 * x + 2, 3) / 2;
                if (t < vidState.duration) progress = ease(t / vidState.duration);
                else if (t < vidState.duration + vidState.pauseDuration) progress = 1;
                else if (t < (vidState.duration * 2) + vidState.pauseDuration) progress = 1 - ease((t - vidState.duration - vidState.pauseDuration) / vidState.duration);
                else progress = 0;

                drawVideoFrame(progress);
                if (vidState.isPlaying) vidState.reqId = requestAnimationFrame(animateVideo);
            };

            const togglePlayVideo = () => {
                if (!vidState.orgImg || !vidState.editImg) return;
                vidState.isPlaying = !vidState.isPlaying;
                vidEls.playText.textContent = vidState.isPlaying ? 'Tạm Dừng' : 'Chạy Thử';
                if (vidState.isPlaying) { vidState.startTime = null; vidState.reqId = requestAnimationFrame(animateVideo); }
                else { cancelAnimationFrame(vidState.reqId); }
            };

            const startRecording = () => {
                if (!vidState.orgImg || !vidState.editImg) return showToast("Vui lòng tải đủ 2 ảnh!", "error");
                const canvas = vidEls.canvas;
                const stream = canvas.captureStream(30);
                let mimeType = 'video/webm'; let ext = 'webm';
                if (MediaRecorder.isTypeSupported('video/mp4')) { mimeType = 'video/mp4'; ext = 'mp4'; }
                else if (MediaRecorder.isTypeSupported('video/webm;codecs=h264')) { mimeType = 'video/webm;codecs=h264'; ext = 'webm'; }
                
                vidState.chunks = [];
                vidState.mediaRecorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 3000000 });
                vidState.mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) vidState.chunks.push(e.data); };
                vidState.mediaRecorder.onstop = () => {
                    const blob = new Blob(vidState.chunks, { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    
                    // MOBILE DETECT: Use Unified Modal for Video
                    if(window.innerWidth < 1024) {
                        showMobileSaveModal(url, 'video', `Compare_Video_${Date.now()}.${ext}`, blob);
                    } else {
                        const a = document.createElement('a'); a.href = url; a.download = `Compare_Video_${Date.now()}.${ext}`; a.click();
                        showToast("Xuất video thành công!", "success");
                    }
                    
                    vidState.isRecording = false; vidState.isPlaying = false;
                    cancelAnimationFrame(vidState.reqId);
                    vidEls.exportProg.style.width = '0%'; vidEls.exportBtn.disabled = false;
                    vidEls.playText.textContent = 'Chạy Thử'; drawVideoFrame(0);
                };

                vidState.mediaRecorder.start();
                vidState.isRecording = true; vidState.isPlaying = true;
                vidState.startTime = null;
                vidEls.exportBtn.disabled = true;
                vidState.reqId = requestAnimationFrame(animateVideo);
            };

            const stopRecording = () => {
                if (vidState.mediaRecorder && vidState.mediaRecorder.state !== 'inactive') vidState.mediaRecorder.stop();
            };

            const resetVideoMode = () => {
                vidState.orgImg = null; vidState.editImg = null; vidState.logoImg = null;
                vidState.isPlaying = false; vidState.isRecording = false; vidState.cacheCanvas = null;
                cancelAnimationFrame(vidState.reqId);
                
                // UI Reset
                vidEls.upOrg.value = ''; vidEls.prevOrg.src = ''; vidEls.prevOrg.classList.add('hidden'); vidEls.phOrg.classList.remove('hidden');
                vidEls.upEdit.value = ''; vidEls.prevEdit.src = ''; vidEls.prevEdit.classList.add('hidden'); vidEls.phEdit.classList.remove('hidden');
                vidEls.canvas.classList.add('hidden'); vidEls.placeholder.classList.remove('hidden');
                vidEls.playBtn.disabled = true; vidEls.playBtn.classList.add('bg-slate-700', 'text-slate-500', 'cursor-not-allowed'); vidEls.playBtn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-500');
                vidEls.exportBtn.disabled = true; vidEls.exportBtn.classList.add('bg-slate-700', 'text-slate-500', 'cursor-not-allowed'); vidEls.exportBtn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-500');
                vidEls.exportProg.style.width = '0%';
                
                showToast("Đã reset Video Mode!", "success");
            };

            const updateLogoUI = () => {
                 if (vidState.logoMode === 'text') {
                     document.getElementById('btn-logo-text').classList.add('bg-blue-600', 'text-white', 'shadow'); document.getElementById('btn-logo-text').classList.remove('text-slate-400', 'hover:text-white');
                     document.getElementById('btn-logo-image').classList.remove('bg-blue-600', 'text-white', 'shadow'); document.getElementById('btn-logo-image').classList.add('text-slate-400', 'hover:text-white');
                     document.getElementById('wm-text-opts').classList.remove('hidden'); document.getElementById('wm-image-opts').classList.add('hidden');
                 } else {
                     document.getElementById('btn-logo-image').classList.add('bg-blue-600', 'text-white', 'shadow'); document.getElementById('btn-logo-image').classList.remove('text-slate-400', 'hover:text-white');
                     document.getElementById('btn-logo-text').classList.remove('bg-blue-600', 'text-white', 'shadow'); document.getElementById('btn-logo-text').classList.add('text-slate-400', 'hover:text-white');
                     document.getElementById('wm-image-opts').classList.remove('hidden'); document.getElementById('wm-text-opts').classList.add('hidden');
                 }
                 vidState.cacheCanvas = null; drawVideoFrame(0);
            };

            // Event Listeners for Video Mode
            if(vidEls.upOrg) vidEls.upOrg.addEventListener('change', (e) => handleVidUpload(e, 'org'));
            if(vidEls.upEdit) vidEls.upEdit.addEventListener('change', (e) => handleVidUpload(e, 'edit'));
            if(vidEls.upLogo) vidEls.upLogo.addEventListener('change', (e) => handleVidUpload(e, 'logo'));
            if(vidEls.playBtn) vidEls.playBtn.addEventListener('click', togglePlayVideo);
            if(vidEls.exportBtn) vidEls.exportBtn.addEventListener('click', startRecording);
            if(vidEls.resetBtn) vidEls.resetBtn.addEventListener('click', resetVideoMode);

            document.querySelectorAll('.vid-ratio-btn').forEach(btn => btn.addEventListener('click', (e) => {
                document.querySelectorAll('.vid-ratio-btn').forEach(b => { b.classList.remove('vid-active-btn'); b.classList.add('vid-inactive-btn'); });
                e.target.classList.add('vid-active-btn'); e.target.classList.remove('vid-inactive-btn');
                vidState.aspectRatio = e.target.dataset.ratio;
                document.getElementById('vid-scale-opts').classList.toggle('hidden', vidState.aspectRatio === 'original');
                vidState.cacheCanvas = null; drawVideoFrame(0);
            }));

            document.querySelectorAll('.vid-scale-btn').forEach(btn => btn.addEventListener('click', (e) => {
                document.querySelectorAll('.vid-scale-btn').forEach(b => { b.classList.remove('vid-active-btn'); b.classList.add('vid-inactive-btn'); });
                e.target.classList.add('vid-active-btn'); e.target.classList.remove('vid-inactive-btn');
                vidState.scaleMode = e.target.dataset.scale; vidState.cacheCanvas = null; drawVideoFrame(0);
            }));

            document.getElementById('btn-logo-text').addEventListener('click', () => { vidState.logoMode = 'text'; updateLogoUI(); });
            document.getElementById('btn-logo-image').addEventListener('click', () => { vidState.logoMode = 'image'; updateLogoUI(); });
            
            vidEls.wmTextInput.addEventListener('input', (e) => { vidState.wmText = e.target.value; vidState.cacheCanvas = null; drawVideoFrame(0); });
            vidEls.wmOpacityInput.addEventListener('input', (e) => { vidState.wmOpacity = e.target.value; vidEls.wmOpacityVal.textContent = e.target.value + '%'; vidState.cacheCanvas = null; drawVideoFrame(0); });
            
            document.querySelectorAll('.wm-style-btn').forEach(btn => btn.addEventListener('click', (e) => {
                document.querySelectorAll('.wm-style-btn').forEach(b => { b.classList.remove('vid-active-btn'); b.classList.add('vid-inactive-btn'); });
                e.target.classList.add('vid-active-btn'); e.target.classList.remove('vid-inactive-btn');
                vidState.wmStyle = e.target.dataset.style; vidState.cacheCanvas = null; drawVideoFrame(0);
            }));

            vidEls.wmLogoPos.addEventListener('change', (e) => { vidState.logoPos = e.target.value; vidState.cacheCanvas = null; drawVideoFrame(0); });
            vidEls.wmLogoSize.addEventListener('input', (e) => { vidState.logoSize = e.target.value; vidState.cacheCanvas = null; drawVideoFrame(0); });

            document.querySelectorAll('.vid-anim-btn').forEach(btn => btn.addEventListener('click', (e) => {
                document.querySelectorAll('.vid-anim-btn').forEach(b => { b.classList.remove('vid-active-btn'); b.classList.add('vid-inactive-btn'); });
                e.target.classList.add('vid-active-btn'); e.target.classList.remove('vid-inactive-btn');
                const anim = e.target.dataset.anim;
                if (anim === 'scan-h') { vidState.animType = 'scan'; vidState.scanDir = 'horizontal'; }
                else if (anim === 'scan-v') { vidState.animType = 'scan'; vidState.scanDir = 'vertical'; }
                else { vidState.animType = 'fade'; }
                drawVideoFrame(0);
            }));

            vidEls.animDur.addEventListener('input', (e) => { vidState.duration = parseFloat(e.target.value); vidEls.animDurVal.textContent = e.target.value + 's'; });
            vidEls.animPause.addEventListener('input', (e) => { vidState.pauseDuration = parseFloat(e.target.value); vidEls.animPauseVal.textContent = e.target.value + 's'; });

            // Initialize Visa, ID, and Video
            renderVisaCountries();
            updateVisaGuides();
            renderCategories();
            
            // Handle Download Menu for existing ID mode
            document.addEventListener('click', (e) => { 
                if(els.dlMenu && !els.dlMenu.contains(e.target) && els.dlTrigger && !els.dlTrigger.contains(e.target)) { els.dlMenu.classList.add('hidden'); } 
                if(els.mobDlMenu && !els.mobDlMenu.contains(e.target) && els.mobDlTrigger && !els.mobDlTrigger.contains(e.target)) { els.mobDlMenu.classList.add('hidden'); } 
            });
            safeAdd(els.fmtPng, 'click', (e) => { e.stopPropagation(); currentFormat = 'image/png'; els.fmtPng.classList.replace('text-slate-500', 'text-white'); els.fmtPng.classList.replace('hover:text-slate-300', 'bg-indigo-600'); els.fmtJpg.classList.replace('text-white', 'text-slate-500'); els.fmtJpg.classList.replace('bg-indigo-600', 'hover:text-slate-300'); }); 
            safeAdd(els.fmtJpg, 'click', (e) => { e.stopPropagation(); currentFormat = 'image/jpeg'; els.fmtJpg.classList.replace('text-slate-500', 'text-white'); els.fmtJpg.classList.replace('hover:text-slate-300', 'bg-indigo-600'); els.fmtPng.classList.replace('text-white', 'text-slate-500'); els.fmtPng.classList.replace('bg-indigo-600', 'hover:text-slate-300'); });
            safeAdd(els.dlTrigger, 'click', (e) => { e.stopPropagation(); if(!els.dlTrigger.disabled && els.dlMenu) els.dlMenu.classList.toggle('hidden'); }); 
            safeAdd(els.mobDlTrigger, 'click', (e) => { e.stopPropagation(); if(!els.mobDlTrigger.disabled && els.mobDlMenu) els.mobDlMenu.classList.toggle('hidden'); }); 
            
            // Background buttons logic
            const bgButtons = document.querySelectorAll('.id-bg-btn'); 
            bgButtons.forEach(btn => { 
                btn.addEventListener('click', () => { 
                    const isActive = btn.classList.contains('ring-2'); 
                    bgButtons.forEach(b => b.classList.remove('ring-2', 'ring-white', 'ring-offset-1', 'ring-offset-black')); 
                    if (isActive) { state.bgPrompt = ""; } else { btn.classList.add('ring-2', 'ring-white', 'ring-offset-1', 'ring-offset-black'); state.bgPrompt = btn.dataset.bg; } 
                }); 
            });
            
            safeAdd(els.dlResult, 'click', () => { const ext = currentFormat === 'image/png' ? 'png' : 'jpg'; dl(`StudioPK_V19_ID_${Date.now()}.${ext}`); if(els.dlMenu) els.dlMenu.classList.add('hidden'); });
            safeAdd(els.mobDlResult, 'click', () => { const ext = currentFormat === 'image/png' ? 'png' : 'jpg'; dl(`StudioPK_V19_ID_${Date.now()}.${ext}`); if(els.mobDlMenu) els.mobDlMenu.classList.add('hidden'); });
            safeAdd(els.dlCompare, 'click', () => { downloadCompare(); if(els.dlMenu) els.dlMenu.classList.add('hidden'); }); safeAdd(els.mobDlCompare, 'click', () => { downloadCompare(); if(els.mobDlMenu) els.mobDlMenu.classList.add('hidden'); });

            // --- UPDATED: UNIFIED MOBILE SAVE/SHARE MODAL LOGIC ---
            const showMobileSaveModal = (src, type = 'image', filename = 'download.png', blob = null) => {
                const modal = document.getElementById('mobile-save-modal');
                const imgEl = document.getElementById('mobile-save-img');
                const vidEl = document.getElementById('mobile-save-video');
                const closeBtn = document.getElementById('close-mobile-save');
                const shareBtn = document.getElementById('mobile-share-btn');
                const descEl = document.getElementById('mobile-modal-desc');
                
                if(modal) {
                    modal.classList.remove('hidden');
                    
                    if (type === 'video') {
                        imgEl.classList.add('hidden');
                        vidEl.classList.remove('hidden');
                        vidEl.src = src;
                        descEl.innerHTML = `Bấm nút trên và chọn <b>"Lưu Video"</b> hoặc <b>"Lưu vào Tệp"</b>.`;
                    } else {
                        vidEl.classList.add('hidden');
                        imgEl.classList.remove('hidden');
                        imgEl.src = src;
                        descEl.innerHTML = `Nhấn giữ ảnh hoặc bấm nút trên để <b>Lưu vào Thư viện Ảnh</b>.`;
                    }
                    
                    // SHARE HANDLER
                    shareBtn.onclick = async () => {
                        try {
                            if (!blob) {
                                // For images from data URL, convert to blob
                                const res = await fetch(src);
                                blob = await res.blob();
                            }
                            
                            const file = new File([blob], filename, { type: blob.type });
                            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                                await navigator.share({
                                    files: [file],
                                    title: 'Studio Phạm Khang',
                                    text: 'Ảnh/Video đã xử lý từ Studio Phạm Khang'
                                });
                                showToast("Đã mở chia sẻ!", "success");
                            } else {
                                // Fallback for browsers without share API
                                const a = document.createElement('a');
                                a.href = src;
                                a.download = filename;
                                a.click();
                                showToast("Đang tải xuống...", "info");
                            }
                        } catch (err) {
                            console.error("Share failed:", err);
                            // Fallback
                             const a = document.createElement('a');
                             a.href = src;
                             a.download = filename;
                             a.click();
                        }
                    };

                    const closeModal = () => {
                        modal.classList.add('hidden');
                        imgEl.src = '';
                        vidEl.src = '';
                    };
                    
                    if(closeBtn) closeBtn.onclick = closeModal;
                    modal.onclick = (e) => { if(e.target === modal) closeModal(); };
                }
            };

            const dl = (name) => { 
                if(!state.restoredObj) return showToast("Không có dữ liệu ảnh!", "error");
                const tempCanvas = document.createElement('canvas'); 
                tempCanvas.width = state.restoredObj.width; 
                tempCanvas.height = state.restoredObj.height; 
                const tempCtx = tempCanvas.getContext('2d'); 
                tempCtx.drawImage(state.restoredObj, 0, 0); 
                const dataUrl = tempCanvas.toDataURL(currentFormat, 1.0); 
                
                // MOBILE DETECT: Use Unified Modal
                if(window.innerWidth < 1024) {
                    showMobileSaveModal(dataUrl, 'image', name);
                } else {
                    const a = document.createElement('a'); 
                    a.download = name; 
                    a.href = dataUrl; 
                    document.body.appendChild(a); 
                    a.click(); 
                    document.body.removeChild(a); 
                    showToast("Đang tải ảnh xuống...", "success");
                }
            };

            const downloadCompare = () => { 
                if(!state.originalImg || !state.restoredObj) return showToast("Vui lòng phục chế ảnh trước!", "error");
                const w = state.originalImg.width, h = state.originalImg.height; 
                const border = Math.max(20, w * 0.02); const bottomLabelH = Math.max(60, h * 0.1); 
                const totalW = w * 2 + border * 3; const totalH = h + border * 2 + bottomLabelH; 
                const tC = document.createElement('canvas'); tC.width = totalW; tC.height = totalH; 
                const tX = tC.getContext('2d'); tX.fillStyle = "#ffffff"; tX.fillRect(0, 0, totalW, totalH); 
                tX.drawImage(state.originalImg, border, border, w, h); tX.drawImage(state.restoredObj, w + border*2, border, w, h); 
                const fontSize = Math.max(24, h * 0.05); tX.font = `bold ${fontSize}px 'Inter', sans-serif`; 
                tX.fillStyle = "rgba(0,0,0,0.7)"; tX.fillRect(border, border, tX.measureText("TRƯỚC").width + fontSize*1.5, fontSize*1.8); tX.fillStyle = "white"; tX.fillText("TRƯỚC", border + fontSize/2, border + fontSize*1.2); 
                tX.fillStyle = "rgba(0,0,0,0.7)"; tX.fillRect(w + border*2, border, tX.measureText("SAU").width + fontSize*1.5, fontSize*1.8); tX.fillStyle = "white"; tX.fillText("SAU", w + border*2 + fontSize/2, border + fontSize*1.2); 
                tX.fillStyle = "#000"; tX.font = `bold ${bottomLabelH * 0.4}px 'Inter', sans-serif`; tX.textAlign = "center"; tX.textBaseline = "middle"; tX.fillText("STUDIO PHẠM KHANG - ID PHOTO MODE", totalW/2, totalH - bottomLabelH/2); 
                
                const dataUrl = tC.toDataURL('image/png');
                
                // MOBILE DETECT: Use Unified Modal
                if(window.innerWidth < 1024) {
                    showMobileSaveModal(dataUrl, 'image', `Compare_V19_ID_${Date.now()}.png`);
                } else {
                    const a = document.createElement('a'); 
                    a.download = `Compare_V19_ID_${Date.now()}.png`; 
                    a.href = dataUrl; 
                    document.body.appendChild(a); 
                    a.click(); 
                    document.body.removeChild(a); 
                    showToast("Đang tải ảnh so sánh...", "success");
                }
            };
        });
    </script>
</body>
</html>